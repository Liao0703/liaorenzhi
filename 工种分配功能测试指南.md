# 工种分配功能测试指南

## 🎯 功能说明

工种分配功能已实现完成，现在管理员可以为每篇文章指定哪些工种的用户可以访问，实现精准的内容权限控制。

## 🚀 快速开始

### 1. 部署功能
```bash
# 执行部署脚本
./deploy-job-types-feature.sh
```

### 2. 重启服务
```bash
# 停止当前服务（Ctrl+C）
# 然后重启
npm run dev
```

## 📖 使用教程

### 管理员操作

#### 创建带工种限制的文章
1. 登录管理员账号，进入管理面板
2. 点击"文章管理"标签
3. 点击"添加文章"按钮
4. 在弹出的编辑器中找到"工种分配"区域
5. 取消勾选"所有工种都可以访问"
6. 选择允许访问的工种（可多选）
7. 填写文章内容，保存

#### 修改现有文章的工种权限
1. 在文章管理列表中找到要修改的文章
2. 点击"编辑"按钮
3. 在"工种分配"区域调整权限设置
4. 保存更改

### 用户体验
- 用户登录后自动只能看到：
  - 所有工种都可访问的文章
  - 分配给自己工种的文章
- 其他文章对用户不可见

## 🧪 测试场景

### 场景1：创建专门给车站值班员的安全规程
```
1. 管理员创建文章"车站值班员安全操作手册"
2. 在工种分配中只选择"车站值班员"
3. 保存文章

期望结果：
- 车站值班员用户登录后能看到此文章
- 其他工种用户看不到此文章
```

### 场景2：创建多工种共享的设备维护文档
```
1. 管理员创建文章"设备日常维护指南"
2. 在工种分配中选择：
   - 连结员
   - 调车长
   - 列尾作业员
3. 保存文章

期望结果：
- 选中的3个工种用户都能看到
- 其他工种用户看不到
```

### 场景3：全员通知类文章
```
1. 管理员创建文章"年度安全培训通知"
2. 保持"所有工种都可以访问"选项勾选
3. 保存文章

期望结果：
- 所有用户都能看到此文章
```

## 🔧 数据库验证

### 查看文章工种分配情况
```sql
-- 查看所有文章的工种分配
SELECT id, title, allowed_job_types FROM articles;

-- 查看特定工种可访问的文章
SELECT id, title FROM articles 
WHERE allowed_job_types IS NULL 
   OR JSON_CONTAINS(allowed_job_types, '"车站值班员"');
```

### 创建测试用户
```sql
-- 创建不同工种的测试用户（密码：demo123456）
INSERT INTO users (username, password, name, job_type, role) VALUES
('station_user', '$2a$10$xn3LI/AjqicNfH0lRQCKl.PBz2neMVhGm9lQSMYgNwCLfPY7LRdFy', '张站长', '车站值班员', 'user'),
('shunter_user', '$2a$10$xn3LI/AjqicNfH0lRQCKl.PBz2neMVhGm9lQSMYgNwCLfPY7LRdFy', '李调车', '调车长', 'user'),
('dispatch_user', '$2a$10$xn3LI/AjqicNfH0lRQCKl.PBz2neMVhGm9lQSMYgNwCLfPY7LRdFy', '王调度', '站调', 'user');
```

## 📋 功能检查清单

### 管理员功能
- [ ] 文章编辑器中显示工种分配选择器
- [ ] 工种按分组正确显示（值班管理、调车作业、调度管理）
- [ ] "所有工种都可以访问"开关正常工作
- [ ] 工种多选功能正常
- [ ] "全选"和"清空"按钮正常工作
- [ ] 保存文章时工种信息正确存储

### 用户访问控制
- [ ] 不同工种用户看到的文章列表不同
- [ ] 无权限文章对用户完全不可见
- [ ] 搜索功能也遵循工种权限
- [ ] 分类筛选遵循工种权限

### 系统稳定性
- [ ] 现有文章默认所有工种可访问
- [ ] 没有工种信息的用户能正常访问所有文章
- [ ] API响应正常，无错误日志
- [ ] 前端界面无报错

## 🐛 常见问题

### Q: 用户看不到任何文章
**A:** 检查用户的 `job_type` 字段是否正确设置，应该是工种列表中的准确名称。

### Q: 工种选择器没有显示
**A:** 检查前端是否正确引入了 `jobTypes.ts` 配置文件。

### Q: 数据库更新失败
**A:** 检查是否有正确的数据库权限，或者字段是否已经存在（重复执行脚本时会出现）。

### Q: API返回错误
**A:** 检查服务器日志，确认 `allowed_job_types` 字段是否正确添加到数据库。

## 🎉 功能亮点

1. **智能权限控制**：基于工种的精准内容分发
2. **用户体验无缝**：用户无感知的权限过滤
3. **管理简单直观**：可视化的工种分配界面
4. **性能优化**：数据库级别的高效查询
5. **向下兼容**：不影响现有功能和数据

---

**测试完成后，您的学习平台将具备按工种精准分配学习内容的强大功能！** 🎊





