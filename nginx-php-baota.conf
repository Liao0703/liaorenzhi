# 宝塔PHP项目Nginx配置
# 适用于域名: 47.109.142.72
# 部署路径: /www/wwwroot/47.109.142.72

server {
    listen 80;
    server_name 47.109.142.72;
    root /www/wwwroot/47.109.142.72;
    index index.html index.php;

    # 安全设置：禁止访问敏感文件
    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    location ~ ^/(composer\.|\.lock$|vendor/|logs/|var/) {
        deny all;
        return 404;
    }

    # 前端静态文件处理 (React应用)
    location / {
        root /www/wwwroot/47.109.142.72/dist;
        try_files $uri $uri/ /index.html;
        
        # 设置正确的MIME类型（修复JavaScript模块加载问题）
        location ~* \.js$ {
            add_header Content-Type "text/javascript; charset=UTF-8";
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=UTF-8";
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # PHP API接口处理
    location /api/ {
        alias /www/wwwroot/47.109.142.72/php-backend/public/;
        try_files $uri @php_api;
        
        # 处理PHP文件
        location ~ \.php$ {
            fastcgi_pass unix:/tmp/php-cgi-74.sock;  # 根据实际PHP版本调整
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            fastcgi_param REQUEST_URI $uri;
            fastcgi_param PATH_INFO $uri;
        }
    }

    # PHP API后备处理
    location @php_api {
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /www/wwwroot/47.109.142.72/php-backend/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param PATH_INFO $uri;
    }

    # 健康检查端点
    location = /health {
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /www/wwwroot/47.109.142.72/php-backend/public/index.php;
        fastcgi_param REQUEST_URI /health;
        fastcgi_param PATH_INFO /health;
    }

    # API测试页面
    location /test-api.html {
        root /www/wwwroot/47.109.142.72/php-backend/public;
    }

    # 文件上传目录
    location /uploads/ {
        root /www/wwwroot/47.109.142.72/php-backend;
        expires 30d;
        add_header Cache-Control "public, no-transform";
        
        # 安全限制：只允许特定文件类型
        location ~* \.(php|html|htm|js)$ {
            deny all;
            return 403;
        }
    }

    # 直接处理PHP后端目录下的请求
    location /php-backend/ {
        alias /www/wwwroot/47.109.142.72/php-backend/;
        
        location ~ \.php$ {
            fastcgi_pass unix:/tmp/php-cgi-74.sock;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }

    # 处理favicon.ico（避免404错误）
    location = /favicon.ico {
        root /www/wwwroot/47.109.142.72/dist;
        access_log off;
        log_not_found off;
        expires 1y;
    }

    # 处理robots.txt
    location = /robots.txt {
        root /www/wwwroot/47.109.142.72/dist;
        access_log off;
        log_not_found off;
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # 安全头设置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # CORS支持 (如需要)
    # add_header Access-Control-Allow-Origin "*" always;
    # add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    # add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;

    # 处理预检请求
    # location = /api {
    #     if ($request_method = 'OPTIONS') {
    #         return 204;
    #     }
    # }

    # 日志设置
    access_log /www/wwwlogs/47.109.142.72.access.log;
    error_log /www/wwwlogs/47.109.142.72.error.log warn;
}

# HTTPS配置 (SSL证书配置后启用)
# server {
#     listen 443 ssl http2;
#     server_name 47.109.142.72;
#     
#     ssl_certificate /www/server/panel/vhost/cert/47.109.142.72/fullchain.pem;
#     ssl_certificate_key /www/server/panel/vhost/cert/47.109.142.72/privkey.pem;
#     
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # 其他配置与HTTP相同...
# }
