# 🚨 宝塔部署问题修复指南 - 47.109.142.72

## 🔍 问题分析

根据错误截图，出现了以下问题：

1. **MIME类型错误**: `Expected a JavaScript module script but the server responded with a MIME type of 'application/octet-stream'`
2. **网站根目录配置错误**: 宝塔面板中根目录设置为 `/www/wwwroot/learning-platform/php-backend`
3. **前端文件未正确部署**: 静态文件无法正确加载

---

## 🛠️ 紧急修复步骤

### 第一步：立即修复宝塔网站配置

1. **登录宝塔面板**
2. **进入网站管理 → 点击 47.109.142.72 的"设置"**
3. **修改网站根目录**:
   ```
   错误配置: /www/wwwroot/learning-platform/php-backend
   正确配置: /www/wwwroot/learning-platform
   ```

4. **重要**: 不要设置运行目录，保持为 `/` 

### 第二步：上传前端构建文件

1. **创建正确的目录结构**:
   ```bash
   # 在服务器上创建目录
   mkdir -p /www/wwwroot/learning-platform/dist
   mkdir -p /www/wwwroot/learning-platform/php-backend
   ```

2. **上传文件**:
   - 将本地的 `dist/` 目录内容上传到: `/www/wwwroot/learning-platform/dist/`
   - 将本地的 `php-backend/` 目录内容上传到: `/www/wwwroot/learning-platform/php-backend/`

### 第三步：配置正确的Nginx规则

**在宝塔面板 → 网站 → 47.109.142.72 → 配置文件**，替换为以下内容：

```nginx
server {
    listen 80;
    server_name 47.109.142.72;
    root /www/wwwroot/learning-platform;
    index index.html;

    # 安全设置
    location ~ /\.(env|git) {
        deny all;
        return 404;
    }

    # 前端React应用 - 主要处理
    location / {
        root /www/wwwroot/learning-platform/dist;
        try_files $uri $uri/ /index.html;
        
        # 修复JavaScript模块MIME类型问题
        location ~* \.js$ {
            add_header Content-Type "text/javascript; charset=UTF-8";
            expires 7d;
            add_header Cache-Control "public";
        }
        
        location ~* \.mjs$ {
            add_header Content-Type "text/javascript; charset=UTF-8";
            expires 7d;
            add_header Cache-Control "public";
        }
        
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=UTF-8";
            expires 7d;
            add_header Cache-Control "public";
        }
        
        location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
    }

    # PHP API接口处理
    location ^~ /api/ {
        # 移除 /api 前缀，转发到 PHP 后端
        rewrite ^/api/(.*)$ /php-backend/public/index.php/$1 last;
    }

    # PHP后端处理
    location ^~ /php-backend/ {
        alias /www/wwwroot/learning-platform/php-backend/;
        
        location ~ \.php$ {
            fastcgi_pass unix:/tmp/php-cgi-74.sock;  # 根据PHP版本调整
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
        }
    }

    # 健康检查
    location = /health {
        rewrite ^/health$ /php-backend/public/index.php/health last;
    }

    # 文件上传处理
    location ^~ /uploads/ {
        alias /www/wwwroot/learning-platform/php-backend/uploads/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/x-javascript;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 日志
    access_log /www/wwwlogs/learning-platform.access.log;
    error_log /www/wwwlogs/learning-platform.error.log;
}
```

### 第四步：设置PHP后端

1. **进入PHP后端目录**:
   ```bash
   cd /www/wwwroot/learning-platform/php-backend
   ```

2. **安装依赖** (如果还未安装):
   ```bash
   composer install --optimize-autoloader --no-dev
   ```

3. **设置权限**:
   ```bash
   chmod -R 755 /www/wwwroot/learning-platform
   chmod -R 777 /www/wwwroot/learning-platform/php-backend/logs
   chmod -R 777 /www/wwwroot/learning-platform/php-backend/uploads
   chown -R www:www /www/wwwroot/learning-platform
   ```

4. **配置环境变量** (创建.env文件):
   ```bash
   cp .env.example .env
   # 然后编辑.env文件设置数据库连接
   ```

### 第五步：创建和配置数据库

1. **在宝塔面板 → 数据库 → 添加数据库**:
   - 数据库名: `learning_platform`
   - 用户名: `learning_platform`
   - 密码: 设置一个强密码

2. **导入数据库**:
   - 上传 `server/init.sql` 文件
   - 在数据库管理中导入SQL文件

3. **更新.env配置**:
   ```env
   DB_HOST=localhost
   DB_DATABASE=learning_platform  
   DB_USERNAME=learning_platform
   DB_PASSWORD=你设置的数据库密码
   ```

---

## ✅ 验证修复

### 测试前端
访问: http://47.109.142.72
- ✅ 应该能看到登录页面
- ✅ 不再有JavaScript MIME类型错误

### 测试后端API
访问: http://47.109.142.72/health
- ✅ 应该返回健康状态JSON

### 测试完整功能
访问: http://47.109.142.72/php-backend/public/test-api.html
- ✅ 可以进行完整的API测试

---

## 🚨 如果仍有问题

### 检查步骤：

1. **查看错误日志**:
   ```bash
   tail -f /www/wwwlogs/learning-platform.error.log
   ```

2. **检查PHP错误日志**:
   ```bash  
   tail -f /www/wwwroot/learning-platform/php-backend/logs/app.log
   ```

3. **验证文件权限**:
   ```bash
   ls -la /www/wwwroot/learning-platform/
   ls -la /www/wwwroot/learning-platform/dist/
   ls -la /www/wwwroot/learning-platform/php-backend/
   ```

4. **测试Nginx配置**:
   ```bash
   nginx -t
   systemctl reload nginx
   ```

---

## 📁 正确的目录结构

修复后的服务器目录结构应该是：
```
/www/wwwroot/learning-platform/
├── dist/                       # 前端构建文件（React应用）
│   ├── index.html
│   ├── assets/
│   │   ├── index-xxx.js       # 主要JS文件
│   │   ├── index-xxx.css      # 样式文件
│   │   └── ...
│   └── ...
├── php-backend/                # PHP后端
│   ├── public/
│   │   ├── index.php          # PHP入口
│   │   └── test-api.html      # API测试页
│   ├── src/
│   ├── config/
│   ├── .env                   # 环境配置
│   └── ...
```

---

## 🎯 默认登录账户

修复完成后，使用以下账户测试：

| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | admin123456 | 管理员 |
| demo | demo123456 | 普通用户 |
| maintenance | maintenance123456 | 维护用户 |

⚠️ **成功登录后请立即修改这些默认密码！**
