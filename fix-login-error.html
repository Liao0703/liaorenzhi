<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç™»å½•é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .success {
            background: #48bb78;
        }
        
        .error {
            background: #f56565;
        }
        
        .warning {
            background: #ed8936;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .result.success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .result.error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .result.warning {
            background: #feebc8;
            color: #744210;
        }
        
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç™»å½•é—®é¢˜è¯Šæ–­å·¥å…·</h1>
        
        <!-- æ­¥éª¤1ï¼šæµ‹è¯•æœåŠ¡å™¨è¿æ¥ -->
        <div class="test-section">
            <h2>æ­¥éª¤ 1ï¼šæµ‹è¯•æœåŠ¡å™¨è¿æ¥</h2>
            <button onclick="testServerConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="serverResult"></div>
        </div>
        
        <!-- æ­¥éª¤2ï¼šæµ‹è¯•CORS -->
        <div class="test-section">
            <h2>æ­¥éª¤ 2ï¼šæµ‹è¯•CORSé…ç½®</h2>
            <button onclick="testCORS()">æµ‹è¯•CORS</button>
            <div id="corsResult"></div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šæµ‹è¯•ç™»å½•API -->
        <div class="test-section">
            <h2>æ­¥éª¤ 3ï¼šæµ‹è¯•ç™»å½•API</h2>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
            <input type="password" id="password" placeholder="å¯†ç " value="123456">
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button onclick="testLoginWithFetch()" class="warning">ä½¿ç”¨Fetchæµ‹è¯•</button>
            <button onclick="testLoginWithXHR()" class="warning">ä½¿ç”¨XHRæµ‹è¯•</button>
            <div id="loginResult"></div>
        </div>
        
        <!-- æ­¥éª¤4ï¼šæ£€æŸ¥ç¯å¢ƒ -->
        <div class="test-section">
            <h2>æ­¥éª¤ 4ï¼šç¯å¢ƒæ£€æŸ¥</h2>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
            <div id="envResult"></div>
        </div>
        
        <!-- æ­¥éª¤5ï¼šä¿®å¤å»ºè®® -->
        <div class="test-section">
            <h2>æ­¥éª¤ 5ï¼šè‡ªåŠ¨ä¿®å¤</h2>
            <button onclick="autoFix()" class="success">å°è¯•è‡ªåŠ¨ä¿®å¤</button>
            <div id="fixResult"></div>
        </div>
    </div>
    
    <script>
        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testServerConnection() {
            const resultDiv = document.getElementById('serverResult');
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•...';
            
            const urls = [
                'http://localhost:3002/api/health',
                'http://localhost:3002/api/status',
                'http://127.0.0.1:3002/api/health'
            ];
            
            for (const url of urls) {
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼
URL: ${url}
çŠ¶æ€: ${data.status}
æ—¶é—´: ${data.timestamp}`;
                    return;
                } catch (error) {
                    console.error(`æµ‹è¯• ${url} å¤±è´¥:`, error);
                }
            }
            
            resultDiv.className = 'result error';
            resultDiv.textContent = 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ';
        }
        
        // æµ‹è¯•CORS
        async function testCORS() {
            const resultDiv = document.getElementById('corsResult');
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•CORS...';
            
            try {
                const response = await fetch('http://localhost:3002/api/cors-test', {
                    method: 'GET',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                
                const data = await response.json();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… CORSé…ç½®æ­£å¸¸ï¼
æ¶ˆæ¯: ${data.message}
æº: ${data.origin || 'æœªè®¾ç½®'}
æ—¶é—´: ${data.timestamp}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ CORSé”™è¯¯: ${error.message}`;
            }
        }
        
        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç™»å½•...';
            
            try {
                const response = await fetch('http://localhost:3002/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ç™»å½•æˆåŠŸï¼
ç”¨æˆ·: ${data.user.username}
è§’è‰²: ${data.user.role}
Token: ${data.token.substring(0, 50)}...`;
                    
                    // ä¿å­˜token
                    localStorage.setItem('auth_token', data.token);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ç™»å½•å¤±è´¥: ${data.error || data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }
        
        // ä½¿ç”¨Fetchæµ‹è¯•
        async function testLoginWithFetch() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'ä½¿ç”¨Fetch APIæµ‹è¯•...';
            
            const code = `
fetch('http://localhost:3002/api/auth/login', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        username: '${username}',
        password: '${password}'
    })
})
.then(res => res.json())
.then(data => console.log('æˆåŠŸ:', data))
.catch(err => console.error('å¤±è´¥:', err));
`;
            
            console.log('æ‰§è¡Œä»£ç :', code);
            eval(code);
            
            resultDiv.textContent = 'è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°';
        }
        
        // ä½¿ç”¨XHRæµ‹è¯•
        function testLoginWithXHR() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'ä½¿ç”¨XMLHttpRequestæµ‹è¯•...';
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://localhost:3002/api/auth/login', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… XHRæˆåŠŸ: ${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ XHRå¤±è´¥: ${xhr.status} ${xhr.statusText}`;
                }
            };
            
            xhr.onerror = function() {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ XHRç½‘ç»œé”™è¯¯';
            };
            
            xhr.send(JSON.stringify({ username, password }));
        }
        
        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const resultDiv = document.getElementById('envResult');
            
            const info = {
                'å½“å‰URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host,
                'ç«¯å£': window.location.port || 'é»˜è®¤',
                'User Agent': navigator.userAgent,
                'LocalStorageå¯ç”¨': typeof Storage !== 'undefined',
                'å·²ä¿å­˜Token': localStorage.getItem('auth_token') ? 'æ˜¯' : 'å¦'
            };
            
            resultDiv.className = 'result success';
            resultDiv.textContent = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
        }
        
        // è‡ªåŠ¨ä¿®å¤
        async function autoFix() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'æ­£åœ¨å°è¯•ä¿®å¤...';
            
            const fixes = [];
            
            // 1. æ¸…é™¤ç¼“å­˜
            localStorage.clear();
            sessionStorage.clear();
            fixes.push('âœ… å·²æ¸…é™¤æœ¬åœ°ç¼“å­˜');
            
            // 2. æµ‹è¯•è¿æ¥
            try {
                const response = await fetch('http://localhost:3002/api/health');
                if (response.ok) {
                    fixes.push('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                }
            } catch (error) {
                fixes.push('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·è¿è¡Œ: npm start');
            }
            
            // 3. æµ‹è¯•ç™»å½•
            try {
                const response = await fetch('http://localhost:3002/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: '123456'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('auth_token', data.token);
                    fixes.push('âœ… ç™»å½•APIæ­£å¸¸ï¼ŒTokenå·²ä¿å­˜');
                } else {
                    fixes.push('âŒ ç™»å½•å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                fixes.push('âŒ ç™»å½•APIé”™è¯¯: ' + error.message);
            }
            
            resultDiv.className = 'result success';
            resultDiv.textContent = fixes.join('\n');
            
            if (fixes.every(f => f.startsWith('âœ…'))) {
                resultDiv.textContent += '\n\nğŸ‰ ä¿®å¤å®Œæˆï¼è¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•';
            } else {
                resultDiv.textContent += '\n\nâš ï¸ éƒ¨åˆ†é—®é¢˜æœªèƒ½è‡ªåŠ¨ä¿®å¤ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            testServerConnection();
        };
    </script>
</body>
</html>
