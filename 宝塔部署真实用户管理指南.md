# 宝塔面板部署真实用户管理功能指南

## 📋 部署目标
将维护人员用户管理页面部署到宝塔服务器，实现直接操作阿里云RDS数据库的真实用户数据。

## 🚀 部署步骤

### 步骤1：通过宝塔面板上传文件

1. **登录宝塔面板**
   - 访问：http://47.109.142.72:8888
   - 输入宝塔账号密码

2. **进入文件管理**
   - 点击左侧菜单【文件】
   - 导航到网站根目录：`/www/wwwroot/learning-platform`

3. **上传核心文件**
   上传以下文件到网站根目录：
   - `maintenance-users-real.html` - 用户管理页面
   - `维护人员用户管理真实数据库方案.md` - 说明文档

### 步骤2：配置后端数据库连接

1. **在宝塔面板中编辑配置文件**
   - 路径：`/www/wwwroot/learning-platform/server/.env`
   - 如果不存在，创建新文件

2. **添加以下配置内容：**
```env
# 生产环境配置 - 连接阿里云RDS
NODE_ENV=production
PORT=3002

# 阿里云RDS MySQL数据库配置
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_USER=admin123
DB_PASSWORD=Liao0820
DB_NAME=learning_platform

# JWT密钥
JWT_SECRET=your-super-secret-jwt-key-learning-platform-2025

# CORS配置
CORS_ORIGIN=http://47.109.142.72,http://localhost:5173

# 应用配置
APP_NAME=兴隆场车站班前学习监督系统
APP_VERSION=2.0.0
```

### 步骤3：修改数据库配置文件

1. **编辑数据库配置**
   - 路径：`/www/wwwroot/learning-platform/server/config/database.js`
   - 找到第6-10行，修改为：

```javascript
const dbConfig = {
  host: process.env.DB_HOST || 'rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com',
  port: process.env.DB_PORT || 3306,
  user: process.env.DB_USER || 'admin123',
  password: process.env.DB_PASSWORD || 'Liao0820',
  database: process.env.DB_NAME || 'learning_platform',
  // ... 其他配置保持不变
};
```

2. **注释或删除内存数据库代码**
   - 找到第41-176行的内存数据库代码
   - 可以注释掉或删除，确保使用真实数据库

### 步骤4：重启Node.js服务

#### 方法A：通过宝塔PM2管理器
1. 点击左侧菜单【软件商店】
2. 找到【PM2管理器】
3. 点击【设置】
4. 找到learning-platform项目
5. 点击【重启】

#### 方法B：通过SSH终端
1. 在宝塔面板点击【终端】
2. 执行以下命令：
```bash
cd /www/wwwroot/learning-platform
pm2 restart all

# 或者如果没有使用PM2
cd /www/wwwroot/learning-platform/server
pkill -f "node.*app.js"
nohup node app.js > /var/log/learning-platform.log 2>&1 &
```

### 步骤5：配置Nginx（如需要）

如果页面无法访问，检查Nginx配置：

1. **在宝塔面板中**
   - 点击【网站】
   - 找到你的站点
   - 点击【设置】
   - 选择【配置文件】

2. **确保有以下配置：**
```nginx
location / {
    root /www/wwwroot/learning-platform;
    try_files $uri $uri/ /index.html;
}

# API代理（如果后端在3002端口）
location /api {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

### 步骤6：测试访问

1. **访问用户管理页面**
   - URL：http://47.109.142.72/maintenance-users-real.html

2. **登录系统**
   - 先访问：http://47.109.142.72
   - 使用以下账号登录：
     - 维护人员：`maintenance` / `123456`
     - 管理员：`admin` / `admin123`

3. **进入用户管理**
   - 登录成功后，访问用户管理页面
   - 应该能看到真实的数据库用户列表

## 🔧 故障排查

### 问题1：页面显示404
**解决方法：**
1. 检查文件是否上传到正确位置
2. 检查文件权限（应该是644）
3. 在宝塔文件管理器中右键文件，选择【权限】，设置为644

### 问题2：显示的还是模拟数据
**解决方法：**
1. 确认.env文件配置正确
2. 重启Node.js服务
3. 清除浏览器缓存
4. 检查server/config/database.js是否正确配置

### 问题3：API请求失败
**解决方法：**
1. 检查Node.js服务是否运行
```bash
ps aux | grep node
netstat -tlnp | grep 3002
```

2. 查看日志
```bash
tail -f /var/log/learning-platform.log
pm2 logs
```

3. 测试API
```bash
curl http://localhost:3002/api/users
```

### 问题4：数据库连接失败
**解决方法：**
1. 测试数据库连接
```bash
mysql -h rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com -u admin123 -pLiao0820 -e "SELECT 1"
```

2. 检查服务器IP是否在RDS白名单中
3. 检查安全组设置

## 📝 快速命令汇总

```bash
# 1. 进入项目目录
cd /www/wwwroot/learning-platform

# 2. 查看Node进程
ps aux | grep node

# 3. 重启服务
pm2 restart all

# 4. 查看日志
pm2 logs
tail -f /var/log/learning-platform.log

# 5. 测试API
curl http://localhost:3002/api/health
curl http://localhost:3002/api/users

# 6. 测试数据库
mysql -h rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com \
      -u admin123 -pLiao0820 learning_platform \
      -e "SELECT COUNT(*) FROM users;"
```

## ✅ 验证部署成功

部署成功后，你应该能够：
1. ✅ 访问 http://47.109.142.72/maintenance-users-real.html
2. ✅ 使用维护账号登录
3. ✅ 看到真实的数据库用户列表
4. ✅ 执行添加、编辑、删除用户操作
5. ✅ 重置用户密码
6. ✅ 修改用户角色

## 🔒 安全提醒

1. **定期备份数据库**
```bash
mysqldump -h rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com \
          -u admin123 -pLiao0820 learning_platform > backup_$(date +%Y%m%d).sql
```

2. **限制访问权限**
   - 只允许授权人员访问用户管理页面
   - 考虑添加IP白名单限制

3. **监控操作日志**
   - 定期查看操作记录
   - 发现异常及时处理

## 📞 需要帮助？

如果遇到问题：
1. 查看本文档的故障排查部分
2. 检查服务器日志
3. 查看项目文档：`/www/wwwroot/learning-platform/project-docs/`
