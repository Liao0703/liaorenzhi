<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ·»åŠ æ–°ç”¨æˆ· - ç­å‰å­¦ä¹ ç›‘ç£ç³»ç»Ÿ</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #374151;
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E5E7EB;
      border-top: 3px solid #2F6BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loading-spinner"></div>
    <div>æ­£åœ¨åŠ è½½æ·»åŠ ç”¨æˆ·çª—å£...</div>
  </div>
  <div id="root"></div>

  <script type="module">
    // åŠ¨æ€å¯¼å…¥Reactå’Œç›¸å…³ä¾èµ–
    import React from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';

    // ç®€åŒ–çš„APIå®¢æˆ·ç«¯
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3002/api' 
      : '/api';

    const apiClient = {
      async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const defaultHeaders = {
          'Content-Type': 'application/json',
        };

        const token = localStorage.getItem('auth_token');
        if (token) {
          defaultHeaders['Authorization'] = `Bearer ${token}`;
        }

        const config = {
          ...options,
          headers: {
            ...defaultHeaders,
            ...options.headers,
          },
        };

        try {
          const response = await fetch(url, config);
          if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          throw error;
        }
      },

      async post(endpoint, data) {
        return this.request(endpoint, {
          method: 'POST',
          body: JSON.stringify(data),
        });
      }
    };

    // ç”¨æˆ·API
    const userAPI = {
      create: (userData) => apiClient.post('/users', userData)
    };

    // AddUserWindowç»„ä»¶
    const AddUserWindow = () => {
      const [loading, setLoading] = React.useState(false);
      const [message, setMessage] = React.useState(null);
      const [formData, setFormData] = React.useState({
        username: '',
        password: '',
        name: '',
        full_name: '',
        role: 'user',
        employee_id: '',
        department: '',
        team: '',
        job_type: '',
        company: '',
        email: '',
        phone: ''
      });

      const departments = ['æœºåŠ¡æ®µ', 'è½¦åŠ¡æ®µ', 'å·¥åŠ¡æ®µ', 'ç”µåŠ¡æ®µ', 'è½¦è¾†æ®µ', 'ä¾›ç”µæ®µ', 'ITéƒ¨é—¨', 'ç®¡ç†éƒ¨é—¨', 'å®‰å…¨éƒ¨é—¨'];
      const jobTypes = ['å¸æœº', 'è°ƒåº¦å‘˜', 'ä¿¡å·å·¥', 'æ£€è½¦å‘˜', 'çº¿è·¯å·¥', 'ç”µæ°”åŒ–å·¥', 'ç³»ç»Ÿç®¡ç†å‘˜', 'å®‰å…¨å‘˜', 'ç®¡ç†å‘˜'];
      const companies = ['é“è·¯å±€', 'æœºåŠ¡æ®µ', 'è½¦åŠ¡æ®µ', 'å·¥åŠ¡æ®µ', 'ç”µåŠ¡æ®µ', 'è½¦è¾†æ®µ', 'ä¾›ç”µæ®µ', 'é€šä¿¡æ®µ', 'å»ºè®¾æ®µ'];

      const handleSave = async () => {
        if (!formData.username || !formData.password) {
          setMessage({ type: 'error', text: 'ç”¨æˆ·åå’Œå¯†ç ä¸ºå¿…å¡«é¡¹' });
          return;
        }

        setLoading(true);
        setMessage(null);

        try {
          await userAPI.create(formData);
          setMessage({ type: 'success', text: 'ç”¨æˆ·æ·»åŠ æˆåŠŸï¼' });
          
          // é€šçŸ¥çˆ¶çª—å£åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
          if (window.opener && !window.opener.closed) {
            try {
              // æ–¹æ³•1ï¼šè°ƒç”¨çˆ¶çª—å£çš„åˆ·æ–°å‡½æ•°
              if (window.opener.refreshUserList) {
                window.opener.refreshUserList();
                console.log('âœ… å·²è°ƒç”¨çˆ¶çª—å£åˆ·æ–°å‡½æ•°');
              }
              
              // æ–¹æ³•2ï¼šå‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£
              window.opener.postMessage({ 
                type: 'USER_DATA_UPDATED',
                action: 'refresh',
                newUser: formData.username
              }, '*');
              console.log('âœ… å·²å‘é€åˆ·æ–°æ¶ˆæ¯åˆ°çˆ¶çª—å£');
              
            } catch (e) {
              console.error('æ— æ³•é€šçŸ¥çˆ¶çª—å£:', e);
            }
          }
          
          setFormData({
            username: '',
            password: '',
            name: '',
            full_name: '',
            role: 'user',
            employee_id: '',
            department: '',
            team: '',
            job_type: '',
            company: '',
            email: '',
            phone: ''
          });

          setTimeout(() => {
            setMessage({ type: 'success', text: 'ç”¨æˆ·æ·»åŠ æˆåŠŸï¼çª—å£å°†åœ¨2ç§’åè‡ªåŠ¨å…³é—­...' });
            // è‡ªåŠ¨å…³é—­çª—å£
            setTimeout(() => {
              window.close();
            }, 2000);
          }, 1000);

        } catch (error) {
          setMessage({ 
            type: 'error', 
            text: error.response?.data?.message || 'æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•' 
          });
        } finally {
          setLoading(false);
        }
      };

      const handleClose = () => {
        if (window.confirm('ç¡®å®šè¦å…³é—­çª—å£å—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚')) {
          window.close();
        }
      };

      const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        borderRadius: '10px',
        border: '1px solid #E5E7EB',
        background: '#fff',
        color: '#111827',
        fontSize: '15px',
        outline: 'none',
        transition: 'all 0.3s ease',
        boxSizing: 'border-box'
      };

      const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '14px',
        color: '#374151',
        fontWeight: '600'
      };

      return React.createElement('div', {
        style: {
          background: '#f8fafc',
          minHeight: '100vh',
          padding: '20px',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif'
        }
      }, [
        // é¡¶éƒ¨æ ‡é¢˜æ 
        React.createElement('div', {
          key: 'header',
          style: {
            background: '#fff',
            borderRadius: '16px',
            padding: '24px 32px',
            marginBottom: '24px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            border: '1px solid #eef0f4',
            boxShadow: '0 6px 24px rgba(17,24,39,0.06)'
          }
        }, [
          React.createElement('div', { key: 'title' }, [
            React.createElement('h1', {
              key: 'h1',
              style: {
                margin: 0,
                fontSize: '24px',
                fontWeight: '700',
                color: '#111827',
                letterSpacing: '0.5px'
              }
            }, 'â• æ·»åŠ æ–°ç”¨æˆ·'),
            React.createElement('p', {
              key: 'p',
              style: {
                margin: '8px 0 0 0',
                color: '#6B7280',
                fontSize: '14px'
              }
            }, 'è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯')
          ]),
          React.createElement('button', {
            key: 'closeBtn',
            onClick: handleClose,
            style: {
              padding: '10px 20px',
              background: '#EF4444',
              color: '#fff',
              border: 'none',
              borderRadius: '10px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500',
              transition: 'all 0.3s ease'
            }
          }, 'âœ• å…³é—­çª—å£')
        ]),

        // æ¶ˆæ¯æç¤º
        message && React.createElement('div', {
          key: 'message',
          style: {
            background: message.type === 'success' 
              ? 'rgba(46, 204, 113, 0.9)' 
              : 'rgba(231, 76, 60, 0.9)',
            color: '#fff',
            padding: '15px 20px',
            borderRadius: '8px',
            marginBottom: '20px',
            fontSize: '14px',
            fontWeight: '500',
            textAlign: 'center',
            backdropFilter: 'blur(10px)',
            boxShadow: '0 4px 15px rgba(0, 0, 0, 0.2)'
          }
        }, message.text),

        // è¡¨å•å†…å®¹
        React.createElement('div', {
          key: 'form',
          style: {
            background: '#fff',
            padding: '32px',
            borderRadius: '16px',
            border: '1px solid #eef0f4',
            boxShadow: '0 6px 24px rgba(17,24,39,0.06)'
          }
        }, [
          React.createElement('div', {
            key: 'fields',
            style: {
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
              gap: '25px',
              marginBottom: '30px'
            }
          }, [
            // ç”¨æˆ·å
            React.createElement('div', { key: 'username' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, 'ç”¨æˆ·å *'),
              React.createElement('input', {
                key: 'input',
                type: 'text',
                value: formData.username,
                onChange: (e) => setFormData({...formData, username: e.target.value}),
                style: inputStyle,
                placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å'
              })
            ]),

            // å¯†ç 
            React.createElement('div', { key: 'password' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, 'å¯†ç  *'),
              React.createElement('input', {
                key: 'input',
                type: 'password',
                value: formData.password,
                onChange: (e) => setFormData({...formData, password: e.target.value}),
                style: inputStyle,
                placeholder: 'è¯·è¾“å…¥å¯†ç '
              })
            ]),

            // å§“å
            React.createElement('div', { key: 'name' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, 'å§“å'),
              React.createElement('input', {
                key: 'input',
                type: 'text',
                value: formData.name,
                onChange: (e) => setFormData({...formData, name: e.target.value}),
                style: inputStyle,
                placeholder: 'è¯·è¾“å…¥å§“å'
              })
            ]),

            // è§’è‰²é€‰æ‹©
            React.createElement('div', { key: 'role' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, 'è§’è‰²'),
              React.createElement('select', {
                key: 'select',
                value: formData.role,
                onChange: (e) => setFormData({...formData, role: e.target.value}),
                style: { ...inputStyle, cursor: 'pointer' }
              }, [
                React.createElement('option', { key: 'user', value: 'user', style: { background: '#fff', color: '#111827' } }, 'æ™®é€šç”¨æˆ·'),
                React.createElement('option', { key: 'maintenance', value: 'maintenance', style: { background: '#fff', color: '#111827' } }, 'ç»´æŠ¤äººå‘˜'),
                React.createElement('option', { key: 'admin', value: 'admin', style: { background: '#fff', color: '#111827' } }, 'ç³»ç»Ÿç®¡ç†å‘˜')
              ])
            ])
          ]),

          // æ“ä½œæŒ‰é’®
          React.createElement('div', {
            key: 'buttons',
            style: {
              display: 'flex',
              gap: '20px',
              justifyContent: 'center',
              flexWrap: 'wrap',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }
          }, [
            React.createElement('button', {
              key: 'reset',
              onClick: () => {
                if (window.confirm('ç¡®å®šè¦é‡ç½®è¡¨å•å—ï¼Ÿ')) {
                  setFormData({
                    username: '',
                    password: '',
                    name: '',
                    full_name: '',
                    role: 'user',
                    employee_id: '',
                    department: '',
                    team: '',
                    job_type: '',
                    company: '',
                    email: '',
                    phone: ''
                  });
                  setMessage(null);
                }
              },
              style: {
                padding: '12px 24px',
                background: '#fff',
                color: '#374151',
                border: '1px solid #D1D5DB',
                borderRadius: '10px',
                cursor: 'pointer',
                fontSize: '15px',
                fontWeight: '500',
                transition: 'all 0.3s ease'
              }
            }, 'ğŸ”„ é‡ç½®è¡¨å•'),

            React.createElement('button', {
              key: 'save',
              onClick: handleSave,
              disabled: loading || !formData.username || !formData.password,
              style: {
                padding: '12px 32px',
                background: loading || !formData.username || !formData.password
                  ? '#9CA3AF'
                  : '#2F6BFF',
                color: '#fff',
                border: 'none',
                borderRadius: '10px',
                cursor: loading || !formData.username || !formData.password ? 'not-allowed' : 'pointer',
                fontSize: '15px',
                fontWeight: '600',
                transition: 'all 0.3s ease'
              }
            }, loading ? 'â³ æ·»åŠ ä¸­...' : 'âœ… æ·»åŠ ç”¨æˆ·')
          ])
        ])
      ]);
    };

    // éšè—åŠ è½½é¡µé¢å¹¶æ¸²æŸ“ç»„ä»¶
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(AddUserWindow));
    }, 500);
  </script>
</body>
</html>