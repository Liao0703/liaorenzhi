<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>添加新用户 - 班前学习监督系统</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #374151;
      z-index: 9999;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E5E7EB;
      border-top: 3px solid #2F6BFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loading-spinner"></div>
    <div>正在加载添加用户窗口...</div>
  </div>
  <div id="root"></div>

  <script type="module">
    // 动态导入React和相关依赖
    import React from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18/client';

    // 简化的API客户端
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3002/api' 
      : '/api';

    const apiClient = {
      async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const defaultHeaders = {
          'Content-Type': 'application/json',
        };

        const token = localStorage.getItem('auth_token');
        if (token) {
          defaultHeaders['Authorization'] = `Bearer ${token}`;
        }

        const config = {
          ...options,
          headers: {
            ...defaultHeaders,
            ...options.headers,
          },
        };

        try {
          const response = await fetch(url, config);
          if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          throw error;
        }
      },

      async post(endpoint, data) {
        return this.request(endpoint, {
          method: 'POST',
          body: JSON.stringify(data),
        });
      }
    };

    // 用户API
    const userAPI = {
      create: (userData) => apiClient.post('/users', userData)
    };

    // AddUserWindow组件
    const AddUserWindow = () => {
      const [loading, setLoading] = React.useState(false);
      const [message, setMessage] = React.useState(null);
      const [formData, setFormData] = React.useState({
        username: '',
        password: '',
        name: '',
        full_name: '',
        role: 'user',
        employee_id: '',
        department: '',
        team: '',
        job_type: '',
        company: '',
        email: '',
        phone: ''
      });

      const departments = ['机务段', '车务段', '工务段', '电务段', '车辆段', '供电段', 'IT部门', '管理部门', '安全部门'];
      const jobTypes = ['司机', '调度员', '信号工', '检车员', '线路工', '电气化工', '系统管理员', '安全员', '管理员'];
      const companies = ['铁路局', '机务段', '车务段', '工务段', '电务段', '车辆段', '供电段', '通信段', '建设段'];

      const handleSave = async () => {
        if (!formData.username || !formData.password) {
          setMessage({ type: 'error', text: '用户名和密码为必填项' });
          return;
        }

        setLoading(true);
        setMessage(null);

        try {
          await userAPI.create(formData);
          setMessage({ type: 'success', text: '用户添加成功！' });
          
          // 通知父窗口刷新用户列表
          if (window.opener && !window.opener.closed) {
            try {
              // 方法1：调用父窗口的刷新函数
              if (window.opener.refreshUserList) {
                window.opener.refreshUserList();
                console.log('✅ 已调用父窗口刷新函数');
              }
              
              // 方法2：发送消息给父窗口
              window.opener.postMessage({ 
                type: 'USER_DATA_UPDATED',
                action: 'refresh',
                newUser: formData.username
              }, '*');
              console.log('✅ 已发送刷新消息到父窗口');
              
            } catch (e) {
              console.error('无法通知父窗口:', e);
            }
          }
          
          setFormData({
            username: '',
            password: '',
            name: '',
            full_name: '',
            role: 'user',
            employee_id: '',
            department: '',
            team: '',
            job_type: '',
            company: '',
            email: '',
            phone: ''
          });

          setTimeout(() => {
            setMessage({ type: 'success', text: '用户添加成功！窗口将在2秒后自动关闭...' });
            // 自动关闭窗口
            setTimeout(() => {
              window.close();
            }, 2000);
          }, 1000);

        } catch (error) {
          setMessage({ 
            type: 'error', 
            text: error.response?.data?.message || '添加用户失败，请重试' 
          });
        } finally {
          setLoading(false);
        }
      };

      const handleClose = () => {
        if (window.confirm('确定要关闭窗口吗？未保存的数据将丢失。')) {
          window.close();
        }
      };

      const inputStyle = {
        width: '100%',
        padding: '12px 16px',
        borderRadius: '10px',
        border: '1px solid #E5E7EB',
        background: '#fff',
        color: '#111827',
        fontSize: '15px',
        outline: 'none',
        transition: 'all 0.3s ease',
        boxSizing: 'border-box'
      };

      const labelStyle = {
        display: 'block',
        marginBottom: '8px',
        fontSize: '14px',
        color: '#374151',
        fontWeight: '600'
      };

      return React.createElement('div', {
        style: {
          background: '#f8fafc',
          minHeight: '100vh',
          padding: '20px',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif'
        }
      }, [
        // 顶部标题栏
        React.createElement('div', {
          key: 'header',
          style: {
            background: '#fff',
            borderRadius: '16px',
            padding: '24px 32px',
            marginBottom: '24px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            border: '1px solid #eef0f4',
            boxShadow: '0 6px 24px rgba(17,24,39,0.06)'
          }
        }, [
          React.createElement('div', { key: 'title' }, [
            React.createElement('h1', {
              key: 'h1',
              style: {
                margin: 0,
                fontSize: '24px',
                fontWeight: '700',
                color: '#111827',
                letterSpacing: '0.5px'
              }
            }, '➕ 添加新用户'),
            React.createElement('p', {
              key: 'p',
              style: {
                margin: '8px 0 0 0',
                color: '#6B7280',
                fontSize: '14px'
              }
            }, '请填写完整的用户信息')
          ]),
          React.createElement('button', {
            key: 'closeBtn',
            onClick: handleClose,
            style: {
              padding: '10px 20px',
              background: '#EF4444',
              color: '#fff',
              border: 'none',
              borderRadius: '10px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500',
              transition: 'all 0.3s ease'
            }
          }, '✕ 关闭窗口')
        ]),

        // 消息提示
        message && React.createElement('div', {
          key: 'message',
          style: {
            background: message.type === 'success' 
              ? 'rgba(46, 204, 113, 0.9)' 
              : 'rgba(231, 76, 60, 0.9)',
            color: '#fff',
            padding: '15px 20px',
            borderRadius: '8px',
            marginBottom: '20px',
            fontSize: '14px',
            fontWeight: '500',
            textAlign: 'center',
            backdropFilter: 'blur(10px)',
            boxShadow: '0 4px 15px rgba(0, 0, 0, 0.2)'
          }
        }, message.text),

        // 表单内容
        React.createElement('div', {
          key: 'form',
          style: {
            background: '#fff',
            padding: '32px',
            borderRadius: '16px',
            border: '1px solid #eef0f4',
            boxShadow: '0 6px 24px rgba(17,24,39,0.06)'
          }
        }, [
          React.createElement('div', {
            key: 'fields',
            style: {
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
              gap: '25px',
              marginBottom: '30px'
            }
          }, [
            // 用户名
            React.createElement('div', { key: 'username' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, '用户名 *'),
              React.createElement('input', {
                key: 'input',
                type: 'text',
                value: formData.username,
                onChange: (e) => setFormData({...formData, username: e.target.value}),
                style: inputStyle,
                placeholder: '请输入用户名'
              })
            ]),

            // 密码
            React.createElement('div', { key: 'password' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, '密码 *'),
              React.createElement('input', {
                key: 'input',
                type: 'password',
                value: formData.password,
                onChange: (e) => setFormData({...formData, password: e.target.value}),
                style: inputStyle,
                placeholder: '请输入密码'
              })
            ]),

            // 姓名
            React.createElement('div', { key: 'name' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, '姓名'),
              React.createElement('input', {
                key: 'input',
                type: 'text',
                value: formData.name,
                onChange: (e) => setFormData({...formData, name: e.target.value}),
                style: inputStyle,
                placeholder: '请输入姓名'
              })
            ]),

            // 角色选择
            React.createElement('div', { key: 'role' }, [
              React.createElement('label', { key: 'label', style: labelStyle }, '角色'),
              React.createElement('select', {
                key: 'select',
                value: formData.role,
                onChange: (e) => setFormData({...formData, role: e.target.value}),
                style: { ...inputStyle, cursor: 'pointer' }
              }, [
                React.createElement('option', { key: 'user', value: 'user', style: { background: '#fff', color: '#111827' } }, '普通用户'),
                React.createElement('option', { key: 'maintenance', value: 'maintenance', style: { background: '#fff', color: '#111827' } }, '维护人员'),
                React.createElement('option', { key: 'admin', value: 'admin', style: { background: '#fff', color: '#111827' } }, '系统管理员')
              ])
            ])
          ]),

          // 操作按钮
          React.createElement('div', {
            key: 'buttons',
            style: {
              display: 'flex',
              gap: '20px',
              justifyContent: 'center',
              flexWrap: 'wrap',
              paddingTop: '20px',
              borderTop: '1px solid #E5E7EB'
            }
          }, [
            React.createElement('button', {
              key: 'reset',
              onClick: () => {
                if (window.confirm('确定要重置表单吗？')) {
                  setFormData({
                    username: '',
                    password: '',
                    name: '',
                    full_name: '',
                    role: 'user',
                    employee_id: '',
                    department: '',
                    team: '',
                    job_type: '',
                    company: '',
                    email: '',
                    phone: ''
                  });
                  setMessage(null);
                }
              },
              style: {
                padding: '12px 24px',
                background: '#fff',
                color: '#374151',
                border: '1px solid #D1D5DB',
                borderRadius: '10px',
                cursor: 'pointer',
                fontSize: '15px',
                fontWeight: '500',
                transition: 'all 0.3s ease'
              }
            }, '🔄 重置表单'),

            React.createElement('button', {
              key: 'save',
              onClick: handleSave,
              disabled: loading || !formData.username || !formData.password,
              style: {
                padding: '12px 32px',
                background: loading || !formData.username || !formData.password
                  ? '#9CA3AF'
                  : '#2F6BFF',
                color: '#fff',
                border: 'none',
                borderRadius: '10px',
                cursor: loading || !formData.username || !formData.password ? 'not-allowed' : 'pointer',
                fontSize: '15px',
                fontWeight: '600',
                transition: 'all 0.3s ease'
              }
            }, loading ? '⏳ 添加中...' : '✅ 添加用户')
          ])
        ])
      ]);
    };

    // 隐藏加载页面并渲染组件
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(AddUserWindow));
    }, 500);
  </script>
</body>
</html>