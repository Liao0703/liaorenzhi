# ğŸš¨ å®å¡”500é”™è¯¯å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ” 500é”™è¯¯æ ¹æœ¬åŸå› åˆ†æ

**500 Internal Server Error** æ˜¯æœåŠ¡å™¨ç«¯ä»£ç æ‰§è¡Œæ—¶å‡ºç°å¼‚å¸¸ï¼Œå…·ä½“åŸå› ï¼š

1. **PHPä»£ç è¯­æ³•é”™è¯¯**: PHPæ–‡ä»¶å­˜åœ¨è¯­æ³•é”™è¯¯æˆ–é€»è¾‘é”™è¯¯
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ•°æ®åº“é…ç½®é”™è¯¯æˆ–è¿æ¥è¶…æ—¶
3. **ç¯å¢ƒå˜é‡ç¼ºå¤±**: .envæ–‡ä»¶é…ç½®ä¸æ­£ç¡®
4. **PHPæ‰©å±•ç¼ºå¤±**: ç¼ºå°‘å¿…è¦çš„PHPæ‰©å±•æ¨¡å—
5. **æ–‡ä»¶æƒé™é—®é¢˜**: PHPæ— æ³•è¯»å†™å¿…è¦æ–‡ä»¶
6. **å†…å­˜æˆ–æ—¶é—´é™åˆ¶**: PHPå†…å­˜ä¸è¶³æˆ–æ‰§è¡Œæ—¶é—´è¶…é™

## ğŸ› ï¸ 500é”™è¯¯ç´§æ€¥ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼ˆæœ€é‡è¦ï¼‰

**ç«‹å³æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯**:
```bash
# æŸ¥çœ‹nginxé”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/learning-platform.error.log

# æŸ¥çœ‹PHPé”™è¯¯æ—¥å¿—
tail -f /www/server/php/74/var/log/php-fpm.log

# æŸ¥çœ‹å®å¡”é¢æ¿é”™è¯¯æ—¥å¿—
tail -f /www/server/nginx/logs/error.log
```

**å¦‚æœæ— æ³•SSHï¼Œåœ¨å®å¡”é¢æ¿ä¸­**:
1. **æ–‡ä»¶ç®¡ç†** â†’ **æ—¥å¿—æ–‡ä»¶** â†’ æŸ¥çœ‹é”™è¯¯æ—¥å¿—
2. **ç½‘ç«™** â†’ **æ—¥å¿—** â†’ æŸ¥çœ‹è®¿é—®å’Œé”™è¯¯æ—¥å¿—

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥PHPåŸºç¡€é…ç½®

**æ£€æŸ¥PHPçŠ¶æ€**:
```bash
# æ£€æŸ¥PHP-FPMçŠ¶æ€
systemctl status php-fpm-74

# é‡å¯PHP-FPM
systemctl restart php-fpm-74

# æ£€æŸ¥PHPæ¨¡å—
php -m | grep -E "(pdo|mysql|curl|json|mbstring)"
```

**åœ¨å®å¡”é¢æ¿ä¸­**:
1. **è½¯ä»¶å•†åº—** â†’ **PHP7.4** â†’ **è®¾ç½®**
2. ç¡®ä¿å®‰è£…äº†ä»¥ä¸‹æ‰©å±•ï¼š
   - `pdo_mysql` âœ…
   - `curl` âœ…
   - `json` âœ…
   - `mbstring` âœ…
   - `openssl` âœ…

### ç¬¬ä¸‰æ­¥ï¼šä¿®å¤æ•°æ®åº“è¿æ¥

**åˆ›å»ºæ•°æ®åº“è¿æ¥æµ‹è¯•æ–‡ä»¶**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/db-test.php << 'EOF'
<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "<h2>æ•°æ®åº“è¿æ¥æµ‹è¯•</h2>";

// å°è¯•è¿æ¥æ•°æ®åº“
try {
    // ä½¿ç”¨æ‚¨çš„å®é™…æ•°æ®åº“é…ç½®
    $host = 'rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com';
    $port = '3306';
    $database = 'learning_platform';
    $username = 'admin123';
    $password = 'Liao0820';
    
    $dsn = "mysql:host={$host};port={$port};dbname={$database};charset=utf8mb4";
    
    echo "æ­£åœ¨è¿æ¥åˆ°: {$host}:{$port}/{$database}<br>";
    
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_TIMEOUT => 30
    ]);
    
    echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ!<br>";
    
    // æµ‹è¯•æŸ¥è¯¢
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM users");
    $result = $stmt->fetch();
    
    echo "âœ… ç”¨æˆ·è¡¨æŸ¥è¯¢æˆåŠŸï¼Œç”¨æˆ·æ•°é‡: " . $result['count'] . "<br>";
    
} catch (Exception $e) {
    echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: " . $e->getMessage() . "<br>";
    echo "é”™è¯¯ä»£ç : " . $e->getCode() . "<br>";
}

echo "<br><h3>PHPä¿¡æ¯</h3>";
echo "PHPç‰ˆæœ¬: " . PHP_VERSION . "<br>";
echo "PDO MySQLæ”¯æŒ: " . (extension_loaded('pdo_mysql') ? 'âœ…' : 'âŒ') . "<br>";
echo "å½“å‰æ—¶é—´: " . date('Y-m-d H:i:s') . "<br>";
?>
EOF
```

**è®¿é—®æµ‹è¯•**: http://47.109.142.72/php-backend/public/db-test.php

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥å’Œä¿®å¤.envé…ç½®

**æ£€æŸ¥.envæ–‡ä»¶æ˜¯å¦å­˜åœ¨**:
```bash
ls -la /www/wwwroot/learning-platform/php-backend/.env
```

**å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º.envæ–‡ä»¶**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/.env << 'EOF'
APP_NAME=LearningPlatform
APP_ENV=production
APP_DEBUG=false

# æ•°æ®åº“é…ç½®ï¼ˆäº‘æ•°æ®åº“ï¼‰
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_DATABASE=learning_platform
DB_USERNAME=admin123
DB_PASSWORD=Liao0820

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-learning-platform-2025
JWT_EXPIRE=86400

# æ—¥å¿—é…ç½®
LOG_LEVEL=error
LOG_PATH=/www/wwwroot/learning-platform/php-backend/logs

# ä¸Šä¼ é…ç½®
UPLOAD_PATH=/www/wwwroot/learning-platform/php-backend/uploads
MAX_UPLOAD_SIZE=52428800
ALLOWED_EXTENSIONS=pdf,doc,docx,txt,json
EOF
```

### ç¬¬äº”æ­¥ï¼šPHPè¯­æ³•æ£€æŸ¥å’Œä¿®å¤

**æ£€æŸ¥PHPæ–‡ä»¶è¯­æ³•**:
```bash
cd /www/wwwroot/learning-platform/php-backend

# æ£€æŸ¥å…¥å£æ–‡ä»¶è¯­æ³•
php -l public/index.php

# æ£€æŸ¥æ‰€æœ‰PHPæ–‡ä»¶è¯­æ³•
find . -name "*.php" -exec php -l {} \;
```

**åˆ›å»ºç®€å•çš„PHPæµ‹è¯•**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/simple-test.php << 'EOF'
<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "<h1>PHPåŸºç¡€æµ‹è¯•</h1>";
echo "âœ… PHPæ­£å¸¸å·¥ä½œ<br>";
echo "PHPç‰ˆæœ¬: " . PHP_VERSION . "<br>";
echo "å½“å‰æ—¶é—´: " . date('Y-m-d H:i:s') . "<br>";

// æµ‹è¯•autoload
if (file_exists('../vendor/autoload.php')) {
    require_once '../vendor/autoload.php';
    echo "âœ… Composer autoloadåŠ è½½æˆåŠŸ<br>";
} else {
    echo "âŒ ç¼ºå°‘vendor/autoload.phpï¼Œè¯·è¿è¡Œcomposer install<br>";
}

// æµ‹è¯•.envåŠ è½½
if (file_exists('../.env')) {
    echo "âœ… .envæ–‡ä»¶å­˜åœ¨<br>";
} else {
    echo "âŒ .envæ–‡ä»¶ç¼ºå¤±<br>";
}

phpinfo();
?>
EOF
```

**è®¿é—®æµ‹è¯•**: http://47.109.142.72/php-backend/public/simple-test.php

### ç¬¬å…­æ­¥ï¼šä¿®å¤Composerä¾èµ–

**é‡æ–°å®‰è£…PHPä¾èµ–**:
```bash
cd /www/wwwroot/learning-platform/php-backend

# åˆ é™¤æ—§çš„vendorç›®å½•
rm -rf vendor

# é‡æ–°å®‰è£…ä¾èµ–
composer install --no-dev --optimize-autoloader

# å¦‚æœcomposerä¸å­˜åœ¨ï¼Œå…ˆå®‰è£…
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
```

### ç¬¬ä¸ƒæ­¥ï¼šä¿®å¤æ–‡ä»¶æƒé™

```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
chown -R www:www /www/wwwroot/learning-platform/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/

# ç‰¹æ®Šç›®å½•éœ€è¦å†™æƒé™
chmod -R 777 /www/wwwroot/learning-platform/php-backend/logs/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/uploads/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/var/

# åˆ›å»ºç¼ºå¤±çš„ç›®å½•
mkdir -p /www/wwwroot/learning-platform/php-backend/logs
mkdir -p /www/wwwroot/learning-platform/php-backend/uploads
mkdir -p /www/wwwroot/learning-platform/php-backend/var/cache
```

### ç¬¬å…«æ­¥ï¼šä¿®å¤PHPé…ç½®

**åœ¨å®å¡”é¢æ¿ä¸­è°ƒæ•´PHPè®¾ç½®**:
1. **è½¯ä»¶å•†åº—** â†’ **PHP7.4** â†’ **è®¾ç½®** â†’ **é…ç½®ä¿®æ”¹**

**é‡è¦é…ç½®é¡¹**:
```ini
# é”™è¯¯æ˜¾ç¤ºï¼ˆè°ƒè¯•æ—¶å¼€å¯ï¼‰
display_errors = On
log_errors = On
error_log = /www/server/php/74/var/log/php_errors.log

# å†…å­˜å’Œæ—¶é—´é™åˆ¶
memory_limit = 256M
max_execution_time = 300
max_input_time = 300

# æ–‡ä»¶ä¸Šä¼ 
upload_max_filesize = 50M
post_max_size = 50M

# æ•°æ®åº“è¿æ¥
default_socket_timeout = 60
mysql.connect_timeout = 60
```

## ğŸ”§ å¸¸è§500é”™è¯¯ç±»å‹åŠè§£å†³æ–¹æ¡ˆ

### 1. Composerä¾èµ–ç¼ºå¤±
**é”™è¯¯**: `Fatal error: require(): Failed opening required 'vendor/autoload.php'`
**è§£å†³**: 
```bash
cd /www/wwwroot/learning-platform/php-backend
composer install
```

### 2. æ•°æ®åº“è¿æ¥è¶…æ—¶
**é”™è¯¯**: `SQLSTATE[HY000] [2002] Connection timed out`
**è§£å†³**: 
- æ£€æŸ¥äº‘æ•°æ®åº“ç™½åå•è®¾ç½®
- ç¡®è®¤æœåŠ¡å™¨IPå·²åŠ å…¥ç™½åå•

### 3. PHPæ‰©å±•ç¼ºå¤±
**é”™è¯¯**: `Call to undefined function pdo_mysql()`
**è§£å†³**: åœ¨å®å¡”é¢æ¿å®‰è£…ç¼ºå¤±çš„PHPæ‰©å±•

### 4. å†…å­˜ä¸è¶³
**é”™è¯¯**: `Fatal error: Allowed memory size exhausted`
**è§£å†³**: åœ¨å®å¡”é¢æ¿è°ƒæ•´PHPå†…å­˜é™åˆ¶

## ğŸ“Š æ•…éšœæ’æŸ¥å‘½ä»¤é›†

```bash
# å®Œæ•´çš„500é”™è¯¯æ’æŸ¥æµç¨‹
echo "=== 500é”™è¯¯æ’æŸ¥å¼€å§‹ ==="

# 1. æ£€æŸ¥é”™è¯¯æ—¥å¿—
echo "1. æŸ¥çœ‹æœ€æ–°é”™è¯¯:"
tail -20 /www/wwwlogs/learning-platform.error.log

# 2. æ£€æŸ¥PHPè¿›ç¨‹
echo "2. PHPè¿›ç¨‹çŠ¶æ€:"
systemctl status php-fpm-74

# 3. æ£€æŸ¥æ–‡ä»¶æƒé™
echo "3. å…³é”®æ–‡ä»¶æƒé™:"
ls -la /www/wwwroot/learning-platform/php-backend/public/index.php
ls -la /www/wwwroot/learning-platform/php-backend/.env
ls -la /www/wwwroot/learning-platform/php-backend/vendor/

# 4. æ£€æŸ¥PHPè¯­æ³•
echo "4. PHPè¯­æ³•æ£€æŸ¥:"
php -l /www/wwwroot/learning-platform/php-backend/public/index.php

# 5. æ£€æŸ¥composer
echo "5. ComposerçŠ¶æ€:"
cd /www/wwwroot/learning-platform/php-backend && composer show

echo "=== æ’æŸ¥å®Œæˆ ==="
```

## âœ… ä¿®å¤éªŒè¯æ­¥éª¤

1. **è®¿é—®ç®€å•æµ‹è¯•**: http://47.109.142.72/php-backend/public/simple-test.php
   - âœ… åº”è¯¥æ˜¾ç¤ºPHPä¿¡æ¯è€Œä¸æ˜¯500é”™è¯¯

2. **è®¿é—®æ•°æ®åº“æµ‹è¯•**: http://47.109.142.72/php-backend/public/db-test.php  
   - âœ… åº”è¯¥æ˜¾ç¤ºæ•°æ®åº“è¿æ¥æˆåŠŸ

3. **è®¿é—®APIæ¥å£**: http://47.109.142.72/api/auth/login
   - âœ… åº”è¯¥è¿”å›JSONå“åº”è€Œä¸æ˜¯500é”™è¯¯

4. **è®¿é—®å‰ç«¯**: http://47.109.142.72
   - âœ… åº”è¯¥æ˜¾ç¤ºç™»å½•é¡µé¢å¹¶èƒ½æ­£å¸¸ä½¿ç”¨

## ğŸš¨ å¦‚æœ500é”™è¯¯ä»ç„¶å­˜åœ¨

**ç«‹å³æ‰§è¡Œä»¥ä¸‹ç´§æ€¥ä¿®å¤**:
```bash
# ç´§æ€¥ä¿®å¤è„šæœ¬
cd /www/wwwroot/learning-platform/php-backend

# é‡å¯æœåŠ¡
systemctl restart php-fpm-74
systemctl restart nginx

# æ¸…ç†ç¼“å­˜
rm -rf var/cache/*

# é‡æ–°å®‰è£…ä¾èµ–
composer install --no-dev

# ä¿®å¤æƒé™
chown -R www:www /www/wwwroot/learning-platform/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/
chmod 777 logs uploads var -R

echo "ç´§æ€¥ä¿®å¤å®Œæˆï¼Œè¯·é‡æ–°æµ‹è¯•"
```

**è”ç³»æˆ‘æ—¶è¯·æä¾›**:
1. å…·ä½“çš„500é”™è¯¯æ—¥å¿—å†…å®¹
2. PHPç‰ˆæœ¬å’Œæ‰©å±•ä¿¡æ¯  
3. æ•°æ®åº“è¿æ¥æµ‹è¯•ç»“æœ
4. Composerä¾èµ–çŠ¶æ€

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ‚¨çš„500é”™è¯¯åº”è¯¥èƒ½å¤Ÿè§£å†³ï¼



