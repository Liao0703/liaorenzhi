# 🚨 宝塔500错误完整修复方案

## 🔍 500错误根本原因分析

**500 Internal Server Error** 是服务器端代码执行时出现异常，具体原因：

1. **PHP代码语法错误**: PHP文件存在语法错误或逻辑错误
2. **数据库连接失败**: 数据库配置错误或连接超时
3. **环境变量缺失**: .env文件配置不正确
4. **PHP扩展缺失**: 缺少必要的PHP扩展模块
5. **文件权限问题**: PHP无法读写必要文件
6. **内存或时间限制**: PHP内存不足或执行时间超限

## 🛠️ 500错误紧急修复步骤

### 第一步：查看错误日志（最重要）

**立即查看具体错误信息**:
```bash
# 查看nginx错误日志
tail -f /www/wwwlogs/learning-platform.error.log

# 查看PHP错误日志
tail -f /www/server/php/74/var/log/php-fpm.log

# 查看宝塔面板错误日志
tail -f /www/server/nginx/logs/error.log
```

**如果无法SSH，在宝塔面板中**:
1. **文件管理** → **日志文件** → 查看错误日志
2. **网站** → **日志** → 查看访问和错误日志

### 第二步：检查PHP基础配置

**检查PHP状态**:
```bash
# 检查PHP-FPM状态
systemctl status php-fpm-74

# 重启PHP-FPM
systemctl restart php-fpm-74

# 检查PHP模块
php -m | grep -E "(pdo|mysql|curl|json|mbstring)"
```

**在宝塔面板中**:
1. **软件商店** → **PHP7.4** → **设置**
2. 确保安装了以下扩展：
   - `pdo_mysql` ✅
   - `curl` ✅
   - `json` ✅
   - `mbstring` ✅
   - `openssl` ✅

### 第三步：修复数据库连接

**创建数据库连接测试文件**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/db-test.php << 'EOF'
<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "<h2>数据库连接测试</h2>";

// 尝试连接数据库
try {
    // 使用您的实际数据库配置
    $host = 'rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com';
    $port = '3306';
    $database = 'learning_platform';
    $username = 'admin123';
    $password = 'Liao0820';
    
    $dsn = "mysql:host={$host};port={$port};dbname={$database};charset=utf8mb4";
    
    echo "正在连接到: {$host}:{$port}/{$database}<br>";
    
    $pdo = new PDO($dsn, $username, $password, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_TIMEOUT => 30
    ]);
    
    echo "✅ 数据库连接成功!<br>";
    
    // 测试查询
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM users");
    $result = $stmt->fetch();
    
    echo "✅ 用户表查询成功，用户数量: " . $result['count'] . "<br>";
    
} catch (Exception $e) {
    echo "❌ 数据库连接失败: " . $e->getMessage() . "<br>";
    echo "错误代码: " . $e->getCode() . "<br>";
}

echo "<br><h3>PHP信息</h3>";
echo "PHP版本: " . PHP_VERSION . "<br>";
echo "PDO MySQL支持: " . (extension_loaded('pdo_mysql') ? '✅' : '❌') . "<br>";
echo "当前时间: " . date('Y-m-d H:i:s') . "<br>";
?>
EOF
```

**访问测试**: http://47.109.142.72/php-backend/public/db-test.php

### 第四步：检查和修复.env配置

**检查.env文件是否存在**:
```bash
ls -la /www/wwwroot/learning-platform/php-backend/.env
```

**如果不存在，创建.env文件**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/.env << 'EOF'
APP_NAME=LearningPlatform
APP_ENV=production
APP_DEBUG=false

# 数据库配置（云数据库）
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_DATABASE=learning_platform
DB_USERNAME=admin123
DB_PASSWORD=Liao0820

# JWT配置
JWT_SECRET=your-super-secret-jwt-key-learning-platform-2025
JWT_EXPIRE=86400

# 日志配置
LOG_LEVEL=error
LOG_PATH=/www/wwwroot/learning-platform/php-backend/logs

# 上传配置
UPLOAD_PATH=/www/wwwroot/learning-platform/php-backend/uploads
MAX_UPLOAD_SIZE=52428800
ALLOWED_EXTENSIONS=pdf,doc,docx,txt,json
EOF
```

### 第五步：PHP语法检查和修复

**检查PHP文件语法**:
```bash
cd /www/wwwroot/learning-platform/php-backend

# 检查入口文件语法
php -l public/index.php

# 检查所有PHP文件语法
find . -name "*.php" -exec php -l {} \;
```

**创建简单的PHP测试**:
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/simple-test.php << 'EOF'
<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

echo "<h1>PHP基础测试</h1>";
echo "✅ PHP正常工作<br>";
echo "PHP版本: " . PHP_VERSION . "<br>";
echo "当前时间: " . date('Y-m-d H:i:s') . "<br>";

// 测试autoload
if (file_exists('../vendor/autoload.php')) {
    require_once '../vendor/autoload.php';
    echo "✅ Composer autoload加载成功<br>";
} else {
    echo "❌ 缺少vendor/autoload.php，请运行composer install<br>";
}

// 测试.env加载
if (file_exists('../.env')) {
    echo "✅ .env文件存在<br>";
} else {
    echo "❌ .env文件缺失<br>";
}

phpinfo();
?>
EOF
```

**访问测试**: http://47.109.142.72/php-backend/public/simple-test.php

### 第六步：修复Composer依赖

**重新安装PHP依赖**:
```bash
cd /www/wwwroot/learning-platform/php-backend

# 删除旧的vendor目录
rm -rf vendor

# 重新安装依赖
composer install --no-dev --optimize-autoloader

# 如果composer不存在，先安装
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
```

### 第七步：修复文件权限

```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/learning-platform/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/

# 特殊目录需要写权限
chmod -R 777 /www/wwwroot/learning-platform/php-backend/logs/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/uploads/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/var/

# 创建缺失的目录
mkdir -p /www/wwwroot/learning-platform/php-backend/logs
mkdir -p /www/wwwroot/learning-platform/php-backend/uploads
mkdir -p /www/wwwroot/learning-platform/php-backend/var/cache
```

### 第八步：修复PHP配置

**在宝塔面板中调整PHP设置**:
1. **软件商店** → **PHP7.4** → **设置** → **配置修改**

**重要配置项**:
```ini
# 错误显示（调试时开启）
display_errors = On
log_errors = On
error_log = /www/server/php/74/var/log/php_errors.log

# 内存和时间限制
memory_limit = 256M
max_execution_time = 300
max_input_time = 300

# 文件上传
upload_max_filesize = 50M
post_max_size = 50M

# 数据库连接
default_socket_timeout = 60
mysql.connect_timeout = 60
```

## 🔧 常见500错误类型及解决方案

### 1. Composer依赖缺失
**错误**: `Fatal error: require(): Failed opening required 'vendor/autoload.php'`
**解决**: 
```bash
cd /www/wwwroot/learning-platform/php-backend
composer install
```

### 2. 数据库连接超时
**错误**: `SQLSTATE[HY000] [2002] Connection timed out`
**解决**: 
- 检查云数据库白名单设置
- 确认服务器IP已加入白名单

### 3. PHP扩展缺失
**错误**: `Call to undefined function pdo_mysql()`
**解决**: 在宝塔面板安装缺失的PHP扩展

### 4. 内存不足
**错误**: `Fatal error: Allowed memory size exhausted`
**解决**: 在宝塔面板调整PHP内存限制

## 📊 故障排查命令集

```bash
# 完整的500错误排查流程
echo "=== 500错误排查开始 ==="

# 1. 检查错误日志
echo "1. 查看最新错误:"
tail -20 /www/wwwlogs/learning-platform.error.log

# 2. 检查PHP进程
echo "2. PHP进程状态:"
systemctl status php-fpm-74

# 3. 检查文件权限
echo "3. 关键文件权限:"
ls -la /www/wwwroot/learning-platform/php-backend/public/index.php
ls -la /www/wwwroot/learning-platform/php-backend/.env
ls -la /www/wwwroot/learning-platform/php-backend/vendor/

# 4. 检查PHP语法
echo "4. PHP语法检查:"
php -l /www/wwwroot/learning-platform/php-backend/public/index.php

# 5. 检查composer
echo "5. Composer状态:"
cd /www/wwwroot/learning-platform/php-backend && composer show

echo "=== 排查完成 ==="
```

## ✅ 修复验证步骤

1. **访问简单测试**: http://47.109.142.72/php-backend/public/simple-test.php
   - ✅ 应该显示PHP信息而不是500错误

2. **访问数据库测试**: http://47.109.142.72/php-backend/public/db-test.php  
   - ✅ 应该显示数据库连接成功

3. **访问API接口**: http://47.109.142.72/api/auth/login
   - ✅ 应该返回JSON响应而不是500错误

4. **访问前端**: http://47.109.142.72
   - ✅ 应该显示登录页面并能正常使用

## 🚨 如果500错误仍然存在

**立即执行以下紧急修复**:
```bash
# 紧急修复脚本
cd /www/wwwroot/learning-platform/php-backend

# 重启服务
systemctl restart php-fpm-74
systemctl restart nginx

# 清理缓存
rm -rf var/cache/*

# 重新安装依赖
composer install --no-dev

# 修复权限
chown -R www:www /www/wwwroot/learning-platform/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/
chmod 777 logs uploads var -R

echo "紧急修复完成，请重新测试"
```

**联系我时请提供**:
1. 具体的500错误日志内容
2. PHP版本和扩展信息  
3. 数据库连接测试结果
4. Composer依赖状态

完成以上步骤后，您的500错误应该能够解决！



