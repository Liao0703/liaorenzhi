# 🚨 宝塔部署502错误完整修复方案

## 🔍 502错误根本原因分析

**502 Bad Gateway** 错误通常表示nginx无法与PHP-FPM进程正确通信，具体原因：

1. **PHP后端依赖未安装**: PHP后端使用Slim框架，需要composer依赖
2. **PHP-FPM进程问题**: PHP-FPM可能未启动或配置错误  
3. **环境配置缺失**: 缺少.env文件和数据库配置
4. **nginx路由配置错误**: API请求无法正确路由到PHP后端
5. **文件权限问题**: PHP文件权限不正确

## 🛠️ 完整修复步骤

### 第一步：检查PHP-FPM状态

在宝塔面板中：
1. **软件商店** → **PHP管理** → **设置**
2. 检查PHP-FPM是否运行中
3. 如果未运行，点击"启动"

### 第二步：安装PHP依赖

SSH连接到服务器，执行：
```bash
cd /www/wwwroot/learning-platform/php-backend

# 检查composer是否安装
which composer || curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# 安装PHP依赖
composer install --no-dev --optimize-autoloader
```

### 第三步：配置环境变量

在 `/www/wwwroot/learning-platform/php-backend/` 目录创建 `.env` 文件：
```bash
cat > /www/wwwroot/learning-platform/php-backend/.env << 'EOF'
APP_NAME=LearningPlatform
APP_ENV=production
APP_DEBUG=false

# 数据库配置（使用与Node.js相同的云数据库）
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_DATABASE=learning_platform
DB_USERNAME=admin123
DB_PASSWORD=Liao0820

# JWT配置
JWT_SECRET=your-super-secret-jwt-key-learning-platform-2025
JWT_EXPIRE=86400

# 日志配置
LOG_LEVEL=error
LOG_PATH=/www/wwwroot/learning-platform/php-backend/logs

# 上传配置
UPLOAD_PATH=/www/wwwroot/learning-platform/php-backend/uploads
MAX_UPLOAD_SIZE=52428800
ALLOWED_EXTENSIONS=pdf,doc,docx,txt,json
EOF
```

### 第四步：修复nginx配置

在宝塔面板 → 网站 → 配置文件，使用以下配置：

```nginx
server {
    listen 80;
    server_name 47.109.142.72;
    root /www/wwwroot/learning-platform;
    index index.html;
    
    # 错误日志
    error_log /www/wwwlogs/learning-platform.error.log;
    access_log /www/wwwlogs/learning-platform.access.log;

    # 前端静态文件
    location / {
        root /www/wwwroot/learning-platform/dist;
        try_files $uri $uri/ /index.html;
        
        # 修复MIME类型
        location ~* \.js$ {
            add_header Content-Type "text/javascript; charset=UTF-8";
        }
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=UTF-8";
        }
    }

    # API请求路由到PHP后端
    location ^~ /api/ {
        # 重写URL去掉/api前缀
        rewrite ^/api/(.*)$ /$1 break;
        
        # 代理到PHP-FPM
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_param SCRIPT_FILENAME /www/wwwroot/learning-platform/php-backend/public/index.php;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param REQUEST_URI /$1$is_args$args;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        
        include fastcgi_params;
    }

    # 直接访问PHP后端（用于测试）
    location ^~ /php-backend/ {
        alias /www/wwwroot/learning-platform/php-backend/;
        
        location ~ \.php$ {
            fastcgi_pass unix:/tmp/php-cgi-74.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
        }
    }

    # 安全设置
    location ~ /\.(env|git) {
        deny all;
        return 404;
    }
}
```

### 第五步：设置文件权限

```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/learning-platform/php-backend/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/logs/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/uploads/
```

### 第六步：创建必要目录

```bash
# 创建日志和上传目录
mkdir -p /www/wwwroot/learning-platform/php-backend/logs
mkdir -p /www/wwwroot/learning-platform/php-backend/uploads
mkdir -p /www/wwwroot/learning-platform/php-backend/var/cache

# 设置权限
chmod 777 /www/wwwroot/learning-platform/php-backend/logs
chmod 777 /www/wwwroot/learning-platform/php-backend/uploads
chmod 777 /www/wwwroot/learning-platform/php-backend/var/cache
```

### 第七步：测试PHP后端

创建测试文件：
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/test.php << 'EOF'
<?php
phpinfo();
EOF
```

访问: `http://47.109.142.72/php-backend/public/test.php`

如果能看到PHP信息页面，说明PHP-FPM正常工作。

### 第八步：验证数据库连接

创建数据库连接测试：
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/db-test.php << 'EOF'
<?php
try {
    $pdo = new PDO(
        'mysql:host=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com;dbname=learning_platform;charset=utf8mb4',
        'admin123',
        'Liao0820',
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]
    );
    
    $stmt = $pdo->query("SELECT COUNT(*) as user_count FROM users");
    $result = $stmt->fetch();
    
    echo json_encode([
        'status' => 'success',
        'message' => '数据库连接正常',
        'user_count' => $result['user_count']
    ]);
} catch (Exception $e) {
    echo json_encode([
        'status' => 'error',
        'message' => '数据库连接失败: ' . $e->getMessage()
    ]);
}
EOF
```

访问: `http://47.109.142.72/php-backend/public/db-test.php`

## 🔧 故障排查命令

```bash
# 检查PHP-FPM状态
systemctl status php-fpm

# 检查nginx错误日志
tail -f /www/wwwlogs/learning-platform.error.log

# 检查PHP错误日志
tail -f /www/server/php/74/var/log/php-fpm.log

# 检查composer依赖
cd /www/wwwroot/learning-platform/php-backend && composer check-platform-reqs

# 测试API接口
curl -X POST http://47.109.142.72/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

## ✅ 修复完成验证

1. **PHP-FPM正常运行**: 访问测试页面不报502
2. **数据库连接成功**: db-test.php返回用户数量
3. **API接口正常**: 登录接口返回正确响应
4. **前端加载正常**: 静态资源正确加载
5. **登录功能正常**: 前端可以成功登录

完成以上步骤后，宝塔部署的502错误应该完全解决。



