# ğŸš¨ å®å¡”éƒ¨ç½²502é”™è¯¯å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ” 502é”™è¯¯æ ¹æœ¬åŸå› åˆ†æ

**502 Bad Gateway** é”™è¯¯é€šå¸¸è¡¨ç¤ºnginxæ— æ³•ä¸PHP-FPMè¿›ç¨‹æ­£ç¡®é€šä¿¡ï¼Œå…·ä½“åŸå› ï¼š

1. **PHPåç«¯ä¾èµ–æœªå®‰è£…**: PHPåç«¯ä½¿ç”¨Slimæ¡†æ¶ï¼Œéœ€è¦composerä¾èµ–
2. **PHP-FPMè¿›ç¨‹é—®é¢˜**: PHP-FPMå¯èƒ½æœªå¯åŠ¨æˆ–é…ç½®é”™è¯¯  
3. **ç¯å¢ƒé…ç½®ç¼ºå¤±**: ç¼ºå°‘.envæ–‡ä»¶å’Œæ•°æ®åº“é…ç½®
4. **nginxè·¯ç”±é…ç½®é”™è¯¯**: APIè¯·æ±‚æ— æ³•æ­£ç¡®è·¯ç”±åˆ°PHPåç«¯
5. **æ–‡ä»¶æƒé™é—®é¢˜**: PHPæ–‡ä»¶æƒé™ä¸æ­£ç¡®

## ğŸ› ï¸ å®Œæ•´ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥PHP-FPMçŠ¶æ€

åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. **è½¯ä»¶å•†åº—** â†’ **PHPç®¡ç†** â†’ **è®¾ç½®**
2. æ£€æŸ¥PHP-FPMæ˜¯å¦è¿è¡Œä¸­
3. å¦‚æœæœªè¿è¡Œï¼Œç‚¹å‡»"å¯åŠ¨"

### ç¬¬äºŒæ­¥ï¼šå®‰è£…PHPä¾èµ–

SSHè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ‰§è¡Œï¼š
```bash
cd /www/wwwroot/learning-platform/php-backend

# æ£€æŸ¥composeræ˜¯å¦å®‰è£…
which composer || curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# å®‰è£…PHPä¾èµ–
composer install --no-dev --optimize-autoloader
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨ `/www/wwwroot/learning-platform/php-backend/` ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š
```bash
cat > /www/wwwroot/learning-platform/php-backend/.env << 'EOF'
APP_NAME=LearningPlatform
APP_ENV=production
APP_DEBUG=false

# æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨ä¸Node.jsç›¸åŒçš„äº‘æ•°æ®åº“ï¼‰
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_DATABASE=learning_platform
DB_USERNAME=admin123
DB_PASSWORD=Liao0820

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-learning-platform-2025
JWT_EXPIRE=86400

# æ—¥å¿—é…ç½®
LOG_LEVEL=error
LOG_PATH=/www/wwwroot/learning-platform/php-backend/logs

# ä¸Šä¼ é…ç½®
UPLOAD_PATH=/www/wwwroot/learning-platform/php-backend/uploads
MAX_UPLOAD_SIZE=52428800
ALLOWED_EXTENSIONS=pdf,doc,docx,txt,json
EOF
```

### ç¬¬å››æ­¥ï¼šä¿®å¤nginxé…ç½®

åœ¨å®å¡”é¢æ¿ â†’ ç½‘ç«™ â†’ é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

```nginx
server {
    listen 80;
    server_name 47.109.142.72;
    root /www/wwwroot/learning-platform;
    index index.html;
    
    # é”™è¯¯æ—¥å¿—
    error_log /www/wwwlogs/learning-platform.error.log;
    access_log /www/wwwlogs/learning-platform.access.log;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /www/wwwroot/learning-platform/dist;
        try_files $uri $uri/ /index.html;
        
        # ä¿®å¤MIMEç±»å‹
        location ~* \.js$ {
            add_header Content-Type "text/javascript; charset=UTF-8";
        }
        location ~* \.css$ {
            add_header Content-Type "text/css; charset=UTF-8";
        }
    }

    # APIè¯·æ±‚è·¯ç”±åˆ°PHPåç«¯
    location ^~ /api/ {
        # é‡å†™URLå»æ‰/apiå‰ç¼€
        rewrite ^/api/(.*)$ /$1 break;
        
        # ä»£ç†åˆ°PHP-FPM
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_param SCRIPT_FILENAME /www/wwwroot/learning-platform/php-backend/public/index.php;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param REQUEST_URI /$1$is_args$args;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
        
        include fastcgi_params;
    }

    # ç›´æ¥è®¿é—®PHPåç«¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    location ^~ /php-backend/ {
        alias /www/wwwroot/learning-platform/php-backend/;
        
        location ~ \.php$ {
            fastcgi_pass unix:/tmp/php-cgi-74.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
        }
    }

    # å®‰å…¨è®¾ç½®
    location ~ /\.(env|git) {
        deny all;
        return 404;
    }
}
```

### ç¬¬äº”æ­¥ï¼šè®¾ç½®æ–‡ä»¶æƒé™

```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
chown -R www:www /www/wwwroot/learning-platform/php-backend/
chmod -R 755 /www/wwwroot/learning-platform/php-backend/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/logs/
chmod -R 777 /www/wwwroot/learning-platform/php-backend/uploads/
```

### ç¬¬å…­æ­¥ï¼šåˆ›å»ºå¿…è¦ç›®å½•

```bash
# åˆ›å»ºæ—¥å¿—å’Œä¸Šä¼ ç›®å½•
mkdir -p /www/wwwroot/learning-platform/php-backend/logs
mkdir -p /www/wwwroot/learning-platform/php-backend/uploads
mkdir -p /www/wwwroot/learning-platform/php-backend/var/cache

# è®¾ç½®æƒé™
chmod 777 /www/wwwroot/learning-platform/php-backend/logs
chmod 777 /www/wwwroot/learning-platform/php-backend/uploads
chmod 777 /www/wwwroot/learning-platform/php-backend/var/cache
```

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•PHPåç«¯

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼š
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/test.php << 'EOF'
<?php
phpinfo();
EOF
```

è®¿é—®: `http://47.109.142.72/php-backend/public/test.php`

å¦‚æœèƒ½çœ‹åˆ°PHPä¿¡æ¯é¡µé¢ï¼Œè¯´æ˜PHP-FPMæ­£å¸¸å·¥ä½œã€‚

### ç¬¬å…«æ­¥ï¼šéªŒè¯æ•°æ®åº“è¿æ¥

åˆ›å»ºæ•°æ®åº“è¿æ¥æµ‹è¯•ï¼š
```bash
cat > /www/wwwroot/learning-platform/php-backend/public/db-test.php << 'EOF'
<?php
try {
    $pdo = new PDO(
        'mysql:host=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com;dbname=learning_platform;charset=utf8mb4',
        'admin123',
        'Liao0820',
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]
    );
    
    $stmt = $pdo->query("SELECT COUNT(*) as user_count FROM users");
    $result = $stmt->fetch();
    
    echo json_encode([
        'status' => 'success',
        'message' => 'æ•°æ®åº“è¿æ¥æ­£å¸¸',
        'user_count' => $result['user_count']
    ]);
} catch (Exception $e) {
    echo json_encode([
        'status' => 'error',
        'message' => 'æ•°æ®åº“è¿æ¥å¤±è´¥: ' . $e->getMessage()
    ]);
}
EOF
```

è®¿é—®: `http://47.109.142.72/php-backend/public/db-test.php`

## ğŸ”§ æ•…éšœæ’æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥PHP-FPMçŠ¶æ€
systemctl status php-fpm

# æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/learning-platform.error.log

# æ£€æŸ¥PHPé”™è¯¯æ—¥å¿—
tail -f /www/server/php/74/var/log/php-fpm.log

# æ£€æŸ¥composerä¾èµ–
cd /www/wwwroot/learning-platform/php-backend && composer check-platform-reqs

# æµ‹è¯•APIæ¥å£
curl -X POST http://47.109.142.72/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

## âœ… ä¿®å¤å®ŒæˆéªŒè¯

1. **PHP-FPMæ­£å¸¸è¿è¡Œ**: è®¿é—®æµ‹è¯•é¡µé¢ä¸æŠ¥502
2. **æ•°æ®åº“è¿æ¥æˆåŠŸ**: db-test.phpè¿”å›ç”¨æˆ·æ•°é‡
3. **APIæ¥å£æ­£å¸¸**: ç™»å½•æ¥å£è¿”å›æ­£ç¡®å“åº”
4. **å‰ç«¯åŠ è½½æ­£å¸¸**: é™æ€èµ„æºæ­£ç¡®åŠ è½½
5. **ç™»å½•åŠŸèƒ½æ­£å¸¸**: å‰ç«¯å¯ä»¥æˆåŠŸç™»å½•

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œå®å¡”éƒ¨ç½²çš„502é”™è¯¯åº”è¯¥å®Œå…¨è§£å†³ã€‚



