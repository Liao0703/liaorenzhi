# 宝塔部署指南

## 问题分析

你遇到的错误是 rollup 原生模块找不到的问题：
```
MODULE_NOT_FOUND: rollup/dist/native.js
```

这通常由以下原因造成：
1. **架构不匹配**：开发环境的 node_modules 与服务器架构不兼容
2. **Node.js 版本过高**：v24.6.0 可能有兼容性问题
3. **依赖安装不完整**：宝塔环境下依赖安装失败

## 解决方案

### 方案一：重新安装依赖（推荐）

1. **删除现有 node_modules**
   ```bash
   cd /www/wwwroot/116.62.65.246/learning-platform
   rm -rf node_modules
   rm -rf package-lock.json
   ```

2. **降级 Node.js 版本（推荐使用 v18.x 或 v20.x）**
   - 在宝塔面板 → 软件商店 → Node.js 管理器
   - 安装 Node.js 18.20.4 或 20.15.1
   - 切换到稳定版本

3. **重新安装依赖**
   ```bash
   npm cache clean --force
   npm install --platform=linux --arch=x64
   ```

### 方案二：分离前后端部署

这个项目包含前端和后端，应该分开处理：

#### 后端部署（推荐优先部署）

1. **进入后端目录**
   ```bash
   cd /www/wwwroot/116.62.65.246/learning-platform/server
   ```

2. **安装后端依赖**
   ```bash
   npm install
   ```

3. **启动后端服务**
   ```bash
   npm start
   # 或者使用 PM2
   pm2 start app.js --name learning-platform-server
   ```

#### 前端构建和部署

1. **在本地构建前端**（避免服务器构建问题）
   ```bash
   # 在你的开发机器上执行
   npm run build
   ```

2. **上传构建产物**
   - 将 `dist` 目录上传到服务器
   - 配置 Nginx 指向 `dist` 目录

### 方案三：使用 Docker 部署（最稳定）

1. **创建 Dockerfile**（已存在）

2. **在宝塔中安装 Docker**

3. **构建和运行**
   ```bash
   cd /www/wwwroot/116.62.65.246/learning-platform
   docker-compose up -d
   ```

## 宝塔配置步骤

### 1. 环境准备

1. **Node.js 版本设置**
   - 推荐：Node.js 18.20.4 或 20.15.1
   - 避免使用：Node.js 24.x（太新，兼容性问题）

2. **创建网站**
   - 域名：116.62.65.246
   - 目录：/www/wwwroot/116.62.65.246/learning-platform

### 2. 后端服务配置

1. **创建 PM2 配置文件**
   ```json
   {
     "apps": [{
       "name": "learning-platform-server",
       "script": "/www/wwwroot/116.62.65.246/learning-platform/server/app.js",
       "cwd": "/www/wwwroot/116.62.65.246/learning-platform/server",
       "env": {
         "NODE_ENV": "production",
         "PORT": "3001"
       },
       "instances": 1,
       "exec_mode": "fork"
     }]
   }
   ```

2. **启动后端服务**
   ```bash
   pm2 start ecosystem.config.js
   pm2 save
   pm2 startup
   ```

### 3. Nginx 配置

1. **前端代理配置**
   ```nginx
   location / {
       try_files $uri $uri/ /index.html;
       root /www/wwwroot/116.62.65.246/learning-platform/dist;
       index index.html;
   }
   ```

2. **API 代理配置**
   ```nginx
   location /api/ {
       proxy_pass http://127.0.0.1:3001/;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   }
   ```

## 快速修复命令

```bash
#!/bin/bash
# 快速修复脚本

echo "正在修复宝塔部署问题..."

# 进入项目目录
cd /www/wwwroot/116.62.65.246/learning-platform

# 清理前端依赖
echo "清理前端依赖..."
rm -rf node_modules package-lock.json

# 清理后端依赖  
echo "清理后端依赖..."
rm -rf server/node_modules server/package-lock.json

# 重新安装后端依赖
echo "安装后端依赖..."
cd server
npm install

# 启动后端服务
echo "启动后端服务..."
pm2 stop learning-platform-server 2>/dev/null || true
pm2 start app.js --name learning-platform-server

echo "修复完成！"
echo "请检查后端服务是否正常运行：pm2 status"
```

## 验证部署

1. **检查后端服务**
   ```bash
   pm2 status
   curl http://localhost:3001/api/health
   ```

2. **检查前端访问**
   - 访问：http://116.62.65.246
   - 检查是否能正常加载页面

3. **检查日志**
   ```bash
   pm2 logs learning-platform-server
   ```

## 常见问题

1. **如果仍然报错**：
   - 确保使用正确的 Node.js 版本
   - 检查宝塔面板的 Node.js 管理器设置

2. **数据库连接问题**：
   - 检查 server/.env 配置
   - 确保数据库服务正常运行

3. **端口冲突**：
   - 修改 server/app.js 中的端口配置
   - 更新 Nginx 代理配置

## 建议

1. **优先部署后端**：先确保 API 服务正常
2. **本地构建前端**：避免服务器构建问题
3. **使用稳定版本**：Node.js 18.x 或 20.x
4. **定期备份**：部署前备份现有配置

需要进一步协助，请提供具体的错误信息。
