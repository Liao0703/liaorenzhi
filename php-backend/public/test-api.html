<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…´ç«™æ™ºè®­é€š PHP APIæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        input, textarea { padding: 5px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸš„ å…´ç«™æ™ºè®­é€š PHP APIæµ‹è¯•</h1>
    
    <div id="basic-tests" class="test-section info">
        <h3>åŸºç¡€è¿æ¥æµ‹è¯•</h3>
        <button onclick="testHealthCheck()">å¥åº·æ£€æŸ¥</button>
        <button onclick="testApiRoot()">APIæ ¹è·¯å¾„</button>
        <div id="basic-results">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <div class="test-section info">
        <h3>ç”¨æˆ·è®¤è¯æµ‹è¯•</h3>
        <div>
            <input type="text" id="username" placeholder="ç”¨æˆ·å" value="demo">
            <input type="password" id="password" placeholder="å¯†ç " value="demo123456">
            <button onclick="testLogin()">ç™»å½•</button>
            <button onclick="testGetUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button onclick="testLogout()">æ³¨é”€</button>
        </div>
        <div id="auth-results"></div>
    </div>

    <div class="test-section info">
        <h3>æ•°æ®ç®¡ç†æµ‹è¯•</h3>
        <button onclick="testGetUsers()">ç”¨æˆ·åˆ—è¡¨</button>
        <button onclick="testGetArticles()">æ–‡ç« åˆ—è¡¨</button>
        <button onclick="testGetLearningRecords()">å­¦ä¹ è®°å½•</button>
        <div id="data-results"></div>
    </div>

    <div class="test-section info">
        <h3>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <input type="file" id="file-input" accept=".json,.txt,.pdf">
        <button onclick="testFileUpload()">ä¸Šä¼ æ–‡ä»¶</button>
        <div id="upload-results"></div>
    </div>

    <div class="test-section info">
        <h3>åˆ›å»ºæµ‹è¯•æ•°æ®</h3>
        <button onclick="createTestArticle()">åˆ›å»ºæµ‹è¯•æ–‡ç« </button>
        <button onclick="createTestLearningRecord()">åˆ›å»ºæµ‹è¯•å­¦ä¹ è®°å½•</button>
        <div id="create-results"></div>
    </div>

    <script>
        let authToken = null;
        const API_BASE = '/api';

        // å·¥å…·å‡½æ•°
        function displayResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.className = `test-section ${isSuccess ? 'success' : 'error'}`;
            element.innerHTML = `<span class="status-indicator ${isSuccess ? 'status-ok' : 'status-error'}"></span>${message}`;
        }

        function formatResponse(data) {
            return '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {}),
                        ...options.headers
                    }
                });

                const data = await response.json();
                return { response, data };
            } catch (error) {
                return { error: error.message };
            }
        }

        // åŸºç¡€æµ‹è¯•
        async function testHealthCheck() {
            const { response, data, error } = await apiCall('/health');
            if (error) {
                displayResult('basic-results', `å¥åº·æ£€æŸ¥å¤±è´¥: ${error}`, false);
                return;
            }
            
            const isSuccess = response.ok && data.success;
            displayResult('basic-results', `å¥åº·æ£€æŸ¥ ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
        }

        async function testApiRoot() {
            const { response, data, error } = await apiCall(`${API_BASE}/`);
            if (error) {
                displayResult('basic-results', `APIæ ¹è·¯å¾„æµ‹è¯•å¤±è´¥: ${error}`, false);
                return;
            }
            
            const isSuccess = response.ok;
            displayResult('basic-results', `APIæ ¹è·¯å¾„ ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
        }

        // è®¤è¯æµ‹è¯•
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const { response, data, error } = await apiCall(`${API_BASE}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (error) {
                displayResult('auth-results', `ç™»å½•å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok && data.success;
            if (isSuccess && data.data && data.data.token) {
                authToken = data.data.token;
                displayResult('auth-results', `ç™»å½•æˆåŠŸ âœ… Tokenå·²ä¿å­˜${formatResponse(data)}`, true);
            } else {
                displayResult('auth-results', `ç™»å½•å¤±è´¥ âŒ${formatResponse(data)}`, false);
            }
        }

        async function testGetUserInfo() {
            if (!authToken) {
                displayResult('auth-results', 'è¯·å…ˆç™»å½•', false);
                return;
            }

            const { response, data, error } = await apiCall(`${API_BASE}/auth/me`);
            if (error) {
                displayResult('auth-results', `è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok && data.success;
            displayResult('auth-results', `ç”¨æˆ·ä¿¡æ¯ ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
        }

        async function testLogout() {
            authToken = null;
            displayResult('auth-results', 'å·²æ³¨é”€ ğŸ“¤ Tokenå·²æ¸…é™¤', true);
        }

        // æ•°æ®æµ‹è¯•
        async function testGetUsers() {
            const { response, data, error } = await apiCall(`${API_BASE}/users`);
            if (error) {
                displayResult('data-results', `è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok;
            displayResult('data-results', `ç”¨æˆ·åˆ—è¡¨ ${isSuccess ? 'âœ…' : 'âŒ'} (${data.data ? data.data.length : 0}ä¸ªç”¨æˆ·)${formatResponse(data)}`, isSuccess);
        }

        async function testGetArticles() {
            const { response, data, error } = await apiCall(`${API_BASE}/articles`);
            if (error) {
                displayResult('data-results', `è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok;
            displayResult('data-results', `æ–‡ç« åˆ—è¡¨ ${isSuccess ? 'âœ…' : 'âŒ'} (${data.data ? data.data.length : 0}ç¯‡æ–‡ç« )${formatResponse(data)}`, isSuccess);
        }

        async function testGetLearningRecords() {
            const { response, data, error } = await apiCall(`${API_BASE}/learning-records`);
            if (error) {
                displayResult('data-results', `è·å–å­¦ä¹ è®°å½•å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok;
            displayResult('data-results', `å­¦ä¹ è®°å½• ${isSuccess ? 'âœ…' : 'âŒ'} (${data.data ? data.data.length : 0}æ¡è®°å½•)${formatResponse(data)}`, isSuccess);
        }

        // æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
        async function testFileUpload() {
            if (!authToken) {
                displayResult('upload-results', 'è¯·å…ˆç™»å½•', false);
                return;
            }

            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) {
                displayResult('upload-results', 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', false);
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/files/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                const isSuccess = response.ok && data.success;
                displayResult('upload-results', `æ–‡ä»¶ä¸Šä¼  ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
            } catch (error) {
                displayResult('upload-results', `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, false);
            }
        }

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        async function createTestArticle() {
            if (!authToken) {
                displayResult('create-results', 'è¯·å…ˆç™»å½•ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰', false);
                return;
            }

            const testArticle = {
                title: 'PHP APIæµ‹è¯•æ–‡ç« ',
                content: 'è¿™æ˜¯ä¸€ç¯‡é€šè¿‡PHP APIåˆ›å»ºçš„æµ‹è¯•æ–‡ç« ã€‚åˆ›å»ºæ—¶é—´ï¼š' + new Date().toLocaleString(),
                category: 'æµ‹è¯•åˆ†ç±»',
                tags: ['æµ‹è¯•', 'PHP', 'API'],
                difficulty: 'easy',
                estimated_time: 5,
                quiz_data: {
                    questions: [
                        {
                            question: 'PHPåç«¯æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ',
                            options: ['æ˜¯', 'å¦'],
                            answer: 0
                        }
                    ]
                }
            };

            const { response, data, error } = await apiCall(`${API_BASE}/articles`, {
                method: 'POST',
                body: JSON.stringify(testArticle)
            });

            if (error) {
                displayResult('create-results', `åˆ›å»ºæ–‡ç« å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok && data.success;
            displayResult('create-results', `åˆ›å»ºæ–‡ç«  ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
        }

        async function createTestLearningRecord() {
            if (!authToken) {
                displayResult('create-results', 'è¯·å…ˆç™»å½•', false);
                return;
            }

            // å…ˆè·å–ä¸€ä¸ªæ–‡ç« ID
            const { data: articlesData } = await apiCall(`${API_BASE}/articles`);
            if (!articlesData.success || !articlesData.data || articlesData.data.length === 0) {
                displayResult('create-results', 'æ²¡æœ‰å¯ç”¨çš„æ–‡ç« ï¼Œè¯·å…ˆåˆ›å»ºæ–‡ç« ', false);
                return;
            }

            const testRecord = {
                article_id: articlesData.data[0].id,
                reading_time: 180,
                completion_rate: 1.0,
                quiz_score: 100,
                quiz_data: { answers: [0] },
                photos_taken: 1
            };

            const { response, data, error } = await apiCall(`${API_BASE}/learning-records`, {
                method: 'POST',
                body: JSON.stringify(testRecord)
            });

            if (error) {
                displayResult('create-results', `åˆ›å»ºå­¦ä¹ è®°å½•å¤±è´¥: ${error}`, false);
                return;
            }

            const isSuccess = response.ok && data.success;
            displayResult('create-results', `åˆ›å»ºå­¦ä¹ è®°å½• ${isSuccess ? 'âœ…' : 'âŒ'}${formatResponse(data)}`, isSuccess);
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.onload = function() {
            document.getElementById('basic-results').innerHTML = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯• API è¿æ¥...';
            document.getElementById('auth-results').innerHTML = 'ä½¿ç”¨é»˜è®¤è´¦æˆ·æµ‹è¯•ï¼šdemo / demo123456';
        };
    </script>
</body>
</html>




