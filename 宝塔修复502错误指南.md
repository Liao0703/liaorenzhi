# å®å¡”é¢æ¿ä¿®å¤502é”™è¯¯æŒ‡å—

## ğŸ”´ é—®é¢˜æè¿°
è®¿é—® http://47.109.142.72 æ—¶å‡ºç°502 Bad Gatewayé”™è¯¯ï¼Œè¿™è¡¨ç¤ºNginxæ— æ³•è¿æ¥åˆ°åç«¯Node.jsæœåŠ¡ã€‚

## ğŸš€ å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ–¹æ³•1ï¼šé€šè¿‡å®å¡”é¢æ¿æ“ä½œ

#### æ­¥éª¤1ï¼šç™»å½•å®å¡”é¢æ¿
- è®¿é—®ï¼šhttp://47.109.142.72:8888
- è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 

#### æ­¥éª¤2ï¼šæ£€æŸ¥Node.jsæœåŠ¡çŠ¶æ€

1. **ç‚¹å‡»ã€ç»ˆç«¯ã€‘**ï¼ˆåœ¨å®å¡”é¢æ¿é¡¶éƒ¨ï¼‰

2. **æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æœåŠ¡ï¼š**
```bash
# æ£€æŸ¥Nodeè¿›ç¨‹
ps aux | grep node

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 3002

# æ£€æŸ¥PM2
pm2 list
```

#### æ­¥éª¤3ï¼šé‡å¯Node.jsæœåŠ¡

**é€‰é¡¹Aï¼šä½¿ç”¨PM2ï¼ˆæ¨èï¼‰**
```bash
cd /www/wwwroot/learning-platform
pm2 stop all
pm2 delete all

# å¦‚æœæœ‰serverç›®å½•
cd server
pm2 start app.js --name learning-platform
pm2 save
```

**é€‰é¡¹Bï¼šç›´æ¥å¯åŠ¨**
```bash
cd /www/wwwroot/learning-platform/server

# æ€æ­»æ—§è¿›ç¨‹
pkill -f "node.*app.js"

# å¯åŠ¨æ–°è¿›ç¨‹
nohup node app.js > /var/log/learning-platform.log 2>&1 &
```

#### æ­¥éª¤4ï¼šåˆ›å»º/æ£€æŸ¥.envé…ç½®æ–‡ä»¶

1. **åœ¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨ä¸­**
   - å¯¼èˆªåˆ°ï¼š`/www/wwwroot/learning-platform/server/`
   - æŸ¥çœ‹æ˜¯å¦æœ‰`.env`æ–‡ä»¶

2. **å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°æ–‡ä»¶`.env`ï¼š**
```env
# æ•°æ®åº“é…ç½®
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_USER=admin123
DB_PASSWORD=Liao0820
DB_NAME=learning_platform

# æœåŠ¡å™¨é…ç½®
PORT=3002
NODE_ENV=production

# JWTé…ç½®
JWT_SECRET=your-secret-key-here-change-in-production

# CORSé…ç½®
CORS_ORIGIN=http://47.109.142.72,http://localhost:5173
```

#### æ­¥éª¤5ï¼šæ£€æŸ¥Nginxé…ç½®

1. **åœ¨å®å¡”é¢æ¿ä¸­**
   - ç‚¹å‡»ã€ç½‘ç«™ã€‘
   - æ‰¾åˆ°ä½ çš„ç«™ç‚¹
   - ç‚¹å‡»ã€è®¾ç½®ã€‘â†’ã€é…ç½®æ–‡ä»¶ã€‘

2. **ç¡®ä¿æœ‰ä»¥ä¸‹é…ç½®ï¼š**
```nginx
# APIä»£ç†é…ç½®
location /api {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# é™æ€æ–‡ä»¶
location / {
    root /www/wwwroot/learning-platform;
    try_files $uri $uri/ /index.html;
}
```

3. **ä¿å­˜å¹¶é‡è½½Nginx**
```bash
nginx -s reload
```

### æ–¹æ³•2ï¼šä½¿ç”¨PM2ç®¡ç†å™¨ï¼ˆå¦‚å·²å®‰è£…ï¼‰

1. **åœ¨å®å¡”è½¯ä»¶å•†åº—**
   - æœç´¢ã€PM2ç®¡ç†å™¨ã€‘
   - ç‚¹å‡»ã€è®¾ç½®ã€‘

2. **æ·»åŠ é¡¹ç›®**
   - é¡¹ç›®è·¯å¾„ï¼š`/www/wwwroot/learning-platform/server`
   - å¯åŠ¨æ–‡ä»¶ï¼š`app.js`
   - é¡¹ç›®åç§°ï¼š`learning-platform`

3. **å¯åŠ¨é¡¹ç›®**
   - ç‚¹å‡»ã€å¯åŠ¨ã€‘æŒ‰é’®

### æ–¹æ³•3ï¼šè®¾ç½®å¼€æœºè‡ªå¯

1. **åˆ›å»ºå¯åŠ¨è„šæœ¬**
   åœ¨`/etc/rc.local`æˆ–åˆ›å»ºsystemdæœåŠ¡ï¼š

```bash
# åˆ›å»ºå¯åŠ¨è„šæœ¬
cat > /www/wwwroot/learning-platform/start.sh << 'EOF'
#!/bin/bash
cd /www/wwwroot/learning-platform/server
/usr/bin/node app.js > /var/log/learning-platform.log 2>&1 &
EOF

chmod +x /www/wwwroot/learning-platform/start.sh
```

2. **æ·»åŠ åˆ°å¼€æœºå¯åŠ¨**
   - åœ¨å®å¡”é¢æ¿ã€è®¡åˆ’ä»»åŠ¡ã€‘
   - æ·»åŠ Shellè„šæœ¬
   - æ‰§è¡Œå‘¨æœŸï¼šå¼€æœºå¯åŠ¨
   - è„šæœ¬å†…å®¹ï¼š`/www/wwwroot/learning-platform/start.sh`

## ğŸ” æ•…éšœæ’æŸ¥

### 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

```bash
# Node.jsæ—¥å¿—
tail -f /var/log/learning-platform.log

# PM2æ—¥å¿—
pm2 logs

# Nginxé”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/47.109.142.72.error.log
```

### 2. å¸¸è§é”™è¯¯åŠè§£å†³

#### é”™è¯¯ï¼šCannot find module
```bash
cd /www/wwwroot/learning-platform/server
npm install
```

#### é”™è¯¯ï¼šEADDRINUSE (ç«¯å£è¢«å ç”¨)
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :3002
# æ€æ­»è¿›ç¨‹
kill -9 [PID]
```

#### é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
- æ£€æŸ¥.envæ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
- æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼š
```bash
mysql -h rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com -u admin123 -pLiao0820 -e "SELECT 1"
```

#### é”™è¯¯ï¼šPermission denied
```bash
# ä¿®å¤æƒé™
chown -R www:www /www/wwwroot/learning-platform
chmod -R 755 /www/wwwroot/learning-platform
```

## âœ… éªŒè¯ä¿®å¤

1. **æµ‹è¯•API**
```bash
curl http://localhost:3002/api/health
```

2. **æµ‹è¯•ç½‘ç«™**
- è®¿é—®ï¼šhttp://47.109.142.72
- å°è¯•ç™»å½•

3. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
```bash
# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep node

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep 3002

# æŸ¥çœ‹PM2
pm2 status
```

## ğŸ“ æ°¸ä¹…è§£å†³æ–¹æ¡ˆ

### 1. å®‰è£…PM2å¹¶è®¾ç½®è‡ªå¯
```bash
# å…¨å±€å®‰è£…PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
cd /www/wwwroot/learning-platform/server
pm2 start app.js --name learning-platform

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
```

### 2. åˆ›å»ºecosystemé…ç½®æ–‡ä»¶
åœ¨`/www/wwwroot/learning-platform`åˆ›å»º`ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'learning-platform',
    script: './server/app.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3002
    }
  }]
};
```

ç„¶åå¯åŠ¨ï¼š
```bash
pm2 start ecosystem.config.js
```

## ğŸ†˜ ç´§æ€¥è”ç³»

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼š
1. æ£€æŸ¥æœåŠ¡å™¨èµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
2. æŸ¥çœ‹å®Œæ•´æ—¥å¿—æ–‡ä»¶
3. é‡å¯æœåŠ¡å™¨ï¼ˆæœ€åæ‰‹æ®µï¼‰

## æµ‹è¯•è´¦å·
- ç®¡ç†å‘˜ï¼š`admin` / `admin123`
- ç»´æŠ¤äººå‘˜ï¼š`maintenance` / `123456`
- æ™®é€šç”¨æˆ·ï¼š`zhangsan` / `123456`
