# 宝塔面板修复502错误指南

## 🔴 问题描述
访问 http://47.109.142.72 时出现502 Bad Gateway错误，这表示Nginx无法连接到后端Node.js服务。

## 🚀 快速修复步骤

### 方法1：通过宝塔面板操作

#### 步骤1：登录宝塔面板
- 访问：http://47.109.142.72:8888
- 输入用户名和密码

#### 步骤2：检查Node.js服务状态

1. **点击【终端】**（在宝塔面板顶部）

2. **执行以下命令检查服务：**
```bash
# 检查Node进程
ps aux | grep node

# 检查端口监听
netstat -tlnp | grep 3002

# 检查PM2
pm2 list
```

#### 步骤3：重启Node.js服务

**选项A：使用PM2（推荐）**
```bash
cd /www/wwwroot/learning-platform
pm2 stop all
pm2 delete all

# 如果有server目录
cd server
pm2 start app.js --name learning-platform
pm2 save
```

**选项B：直接启动**
```bash
cd /www/wwwroot/learning-platform/server

# 杀死旧进程
pkill -f "node.*app.js"

# 启动新进程
nohup node app.js > /var/log/learning-platform.log 2>&1 &
```

#### 步骤4：创建/检查.env配置文件

1. **在宝塔文件管理器中**
   - 导航到：`/www/wwwroot/learning-platform/server/`
   - 查看是否有`.env`文件

2. **如果没有，创建新文件`.env`：**
```env
# 数据库配置
DB_HOST=rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com
DB_PORT=3306
DB_USER=admin123
DB_PASSWORD=Liao0820
DB_NAME=learning_platform

# 服务器配置
PORT=3002
NODE_ENV=production

# JWT配置
JWT_SECRET=your-secret-key-here-change-in-production

# CORS配置
CORS_ORIGIN=http://47.109.142.72,http://localhost:5173
```

#### 步骤5：检查Nginx配置

1. **在宝塔面板中**
   - 点击【网站】
   - 找到你的站点
   - 点击【设置】→【配置文件】

2. **确保有以下配置：**
```nginx
# API代理配置
location /api {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# 静态文件
location / {
    root /www/wwwroot/learning-platform;
    try_files $uri $uri/ /index.html;
}
```

3. **保存并重载Nginx**
```bash
nginx -s reload
```

### 方法2：使用PM2管理器（如已安装）

1. **在宝塔软件商店**
   - 搜索【PM2管理器】
   - 点击【设置】

2. **添加项目**
   - 项目路径：`/www/wwwroot/learning-platform/server`
   - 启动文件：`app.js`
   - 项目名称：`learning-platform`

3. **启动项目**
   - 点击【启动】按钮

### 方法3：设置开机自启

1. **创建启动脚本**
   在`/etc/rc.local`或创建systemd服务：

```bash
# 创建启动脚本
cat > /www/wwwroot/learning-platform/start.sh << 'EOF'
#!/bin/bash
cd /www/wwwroot/learning-platform/server
/usr/bin/node app.js > /var/log/learning-platform.log 2>&1 &
EOF

chmod +x /www/wwwroot/learning-platform/start.sh
```

2. **添加到开机启动**
   - 在宝塔面板【计划任务】
   - 添加Shell脚本
   - 执行周期：开机启动
   - 脚本内容：`/www/wwwroot/learning-platform/start.sh`

## 🔍 故障排查

### 1. 查看错误日志

```bash
# Node.js日志
tail -f /var/log/learning-platform.log

# PM2日志
pm2 logs

# Nginx错误日志
tail -f /www/wwwlogs/47.109.142.72.error.log
```

### 2. 常见错误及解决

#### 错误：Cannot find module
```bash
cd /www/wwwroot/learning-platform/server
npm install
```

#### 错误：EADDRINUSE (端口被占用)
```bash
# 查找占用端口的进程
lsof -i :3002
# 杀死进程
kill -9 [PID]
```

#### 错误：数据库连接失败
- 检查.env文件中的数据库配置
- 测试数据库连接：
```bash
mysql -h rm-cn-7js4el1by00015fo.rwlb.cn-chengdu.rds.aliyuncs.com -u admin123 -pLiao0820 -e "SELECT 1"
```

#### 错误：Permission denied
```bash
# 修复权限
chown -R www:www /www/wwwroot/learning-platform
chmod -R 755 /www/wwwroot/learning-platform
```

## ✅ 验证修复

1. **测试API**
```bash
curl http://localhost:3002/api/health
```

2. **测试网站**
- 访问：http://47.109.142.72
- 尝试登录

3. **检查服务状态**
```bash
# 查看进程
ps aux | grep node

# 查看端口
netstat -tlnp | grep 3002

# 查看PM2
pm2 status
```

## 📝 永久解决方案

### 1. 安装PM2并设置自启
```bash
# 全局安装PM2
npm install -g pm2

# 启动应用
cd /www/wwwroot/learning-platform/server
pm2 start app.js --name learning-platform

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

### 2. 创建ecosystem配置文件
在`/www/wwwroot/learning-platform`创建`ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'learning-platform',
    script: './server/app.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3002
    }
  }]
};
```

然后启动：
```bash
pm2 start ecosystem.config.js
```

## 🆘 紧急联系

如果问题仍未解决：
1. 检查服务器资源（CPU、内存、磁盘）
2. 查看完整日志文件
3. 重启服务器（最后手段）

## 测试账号
- 管理员：`admin` / `admin123`
- 维护人员：`maintenance` / `123456`
- 普通用户：`zhangsan` / `123456`
