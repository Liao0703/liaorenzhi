# 🔧 通过宝塔面板修复500错误指南

## 📋 准备工作

### 1. 访问宝塔面板
- 地址：http://47.109.142.72:8888
- 需要宝塔面板的用户名和密码

> **注意**：如果没有宝塔面板密码，可以通过SSH登录服务器后执行 `bt default` 查看默认信息

## 🚀 修复步骤

### 步骤1：登录宝塔面板后的操作

#### 1.1 使用终端功能
1. 在左侧菜单找到 **"终端"**
2. 点击进入Web终端
3. 执行以下命令：

```bash
# 进入项目目录
cd /www/wwwroot/learning-platform

# 停止所有Node进程
pm2 stop all
pm2 delete all

# 强制停止端口进程
lsof -ti:3002 | xargs kill -9 2>/dev/null || true
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# 重启服务
NODE_ENV=production pm2 start server.cjs --name "learning-platform" --instances 1
pm2 save

# 检查服务状态
pm2 status
```

#### 1.2 使用文件管理器
1. 点击左侧菜单 **"文件"**
2. 导航到：`/www/wwwroot/learning-platform`
3. 检查以下文件是否存在：
   - ✅ `server.cjs`
   - ✅ `env.cloud`
   - ✅ `node_modules/` 文件夹
   - ✅ `dist/` 文件夹

### 步骤2：通过网站管理修复

#### 2.1 检查网站配置
1. 点击左侧菜单 **"网站"**
2. 找到你的站点（域名可能是 47.109.142.72）
3. 点击 **"设置"**

#### 2.2 检查Node项目设置
1. 在网站设置中找到 **"Node项目"** 选项
2. 检查配置：
   - 项目路径：`/www/wwwroot/learning-platform`
   - 启动文件：`server.cjs`
   - 端口：`3002`
   - 启动参数：`NODE_ENV=production`

#### 2.3 重启Node项目
1. 在Node项目设置中点击 **"停止"**
2. 等待几秒后点击 **"启动"**
3. 查看启动日志是否有错误

### 步骤3：检查和修复Nginx配置

#### 3.1 查看Nginx配置
1. 在网站设置中找到 **"配置文件"**
2. 确保包含以下关键配置：

```nginx
server {
    listen 80;
    server_name 47.109.142.72;
    root /www/wwwroot/learning-platform/dist;
    index index.html;

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:3002/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

#### 3.2 重载Nginx
1. 在宝塔面板首页找到 **"Nginx"**
2. 点击 **"重载配置"**

### 步骤4：查看日志诊断问题

#### 4.1 查看PM2日志
在终端中执行：
```bash
pm2 logs learning-platform --lines 50
```

#### 4.2 查看错误日志
1. 在文件管理器中导航到：`/www/wwwlogs/`
2. 查看以下日志文件：
   - `learning-platform-pm2.log`
   - `learning-platform-error.log`
   - `47.109.142.72.error.log`

## 🛠️ 常见问题解决

### 问题1：端口被占用
```bash
# 在终端执行
lsof -ti:3002 | xargs kill -9
```

### 问题2：权限问题
```bash
# 修复文件权限
chown -R www:www /www/wwwroot/learning-platform
chmod -R 755 /www/wwwroot/learning-platform
```

### 问题3：依赖缺失
```bash
cd /www/wwwroot/learning-platform
npm install --production
```

## ✅ 验证修复结果

### 1. 在宝塔终端测试
```bash
# 测试健康检查
curl http://127.0.0.1:3002/health

# 测试API状态
curl http://127.0.0.1:3002/api/status
```

### 2. 浏览器访问测试
- 访问：http://47.109.142.72
- 应该看到登录页面而不是500错误

## 🆘 如果还是无法解决

### 获取宝塔面板密码
如果忘记宝塔面板密码，需要SSH登录服务器后执行：
```bash
# 查看面板入口信息
bt default

# 重置面板密码
bt 5
```

### 备选方案
1. 使用宝塔的 **"计划任务"** 功能创建脚本任务
2. 联系有服务器SSH权限的管理员
3. 通过云服务商的控制台重置服务器密码

---

**提示**：宝塔面板的具体界面可能因版本不同略有差异，但基本功能位置相似。


