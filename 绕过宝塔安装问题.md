# 绕过宝塔依赖安装问题解决方案

## 问题分析

宝塔面板显示"项目依赖安装异常"是因为：
- 宝塔尝试在项目根目录安装所有依赖（包括前端）
- 前端包含 rollup 原生模块，在服务器环境下安装失败
- 宝塔的 Node.js 项目管理机制有局限性

## 完整解决方案

### 🚫 停止使用宝塔 Node.js 项目管理

**重要：不要再使用宝塔的 Node.js 项目管理功能！**

### ✅ 改用手动部署方式

#### 步骤1：清理宝塔配置

1. **删除现有 Node.js 项目**
   - 宝塔面板 → Node.js → 删除项目
   
2. **删除冲突网站**（如果有）
   - 网站管理 → 删除相关域名配置

#### 步骤2：手动安装后端服务

```bash
# SSH 连接到服务器后执行：

# 进入项目目录
cd /www/wwwroot/116.62.65.246/learning-platform

# 彻底清理依赖
rm -rf node_modules package-lock.json

# 进入后端目录
cd server

# 清理后端依赖
rm -rf node_modules package-lock.json

# 检查 package.json
cat package.json

# 安装后端依赖（只安装生产环境依赖）
npm cache clean --force
npm install --production --no-optional --registry https://registry.npmmirror.com

# 验证安装
node -e "console.log('Node.js works!')"
npm list --depth=0

# 测试后端启动
node app.js &
sleep 5
kill %1

# 使用 PM2 正式启动
pm2 start app.js --name learning-platform-server
pm2 save
pm2 startup

# 检查状态
pm2 status
pm2 logs learning-platform-server --lines 20
```

#### 步骤3：配置网站访问

**方式A：直接访问后端（临时测试）**
- 访问：`http://116.62.65.246:3001`

**方式B：配置 Nginx 代理（推荐）**

1. **创建网站**：
   ```
   域名: 116.62.65.246
   端口: 80
   网站目录: /www/wwwroot/116.62.65.246/html
   ```

2. **配置 Nginx**：
   ```nginx
   # 在网站设置 → 配置文件中添加：
   
   location / {
       proxy_pass http://127.0.0.1:3001;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }
   ```

#### 步骤4：验证部署

```bash
# 检查服务状态
pm2 status

# 检查端口监听
netstat -tlnp | grep 3001

# 测试 API 响应
curl http://localhost:3001/
curl http://127.0.0.1:3001/api/health

# 检查日志
pm2 logs learning-platform-server
```

### 🔧 故障排除

#### 如果 npm install 失败：

```bash
# 尝试不同的 registry
npm install --production --registry https://registry.npmmirror.com

# 或使用 cnpm
npm install -g cnpm --registry https://registry.npmmirror.com
cnpm install --production
```

#### 如果端口被占用：

```bash
# 查找占用端口的进程
lsof -i :3001
netstat -tlnp | grep 3001

# 修改端口（在 server/app.js 中）
# 将 PORT 改为其他值，如 3002
```

#### 如果 PM2 启动失败：

```bash
# 检查 PM2 状态
pm2 list

# 查看错误日志
pm2 logs learning-platform-server --err

# 重新启动
pm2 restart learning-platform-server
```

### 🎯 最终配置

成功后你将拥有：
- ✅ 后端 API 服务运行在 3001 端口
- ✅ PM2 管理进程，开机自启
- ✅ Nginx 代理，通过 80 端口访问
- ✅ 完全绕过宝塔的依赖管理问题

### 📝 注意事项

1. **不要**再使用宝塔的 Node.js 项目管理
2. **只运行**后端服务，前端单独部署
3. **使用 PM2** 管理进程，不依赖宝塔
4. **定期备份** PM2 配置：`pm2 save`

### 🚀 后续部署前端

如需部署前端：
1. 本地执行 `npm run build` 生成 `dist` 文件夹
2. 上传 `dist` 到服务器
3. 配置 Nginx 指向 `dist` 目录
